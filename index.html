<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Chain 4.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            padding: 30px;
        }
        h1 {
            color: #1e3c72;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }
        .screen { display: none; }
        .screen.active { display: block; }

        .btn {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn.secondary { background: #6c757d; }

        .input-group { margin: 20px 0; }
        .input-group label {
            display: block;
            color: #333;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1em;
        }
        .input-group input:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .room-code-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            font-size: 1.5em;
            font-weight: bold;
            letter-spacing: 3px;
        }

        .team-card {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .team-card:hover { border-color: #1e3c72; transform: translateY(-3px); }
        .team-card.selected { border-color: #1e3c72; background: #e3f2fd; }
        .team-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .voting-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        .vote-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .vote-option:hover { border-color: #1e3c72; }
        .vote-count {
            background: #1e3c72;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .leaderboard {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        .leaderboard h3 {
            color: #1e3c72;
            margin-bottom: 15px;
            text-align: center;
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #ccc;
        }
        .leaderboard-item.first {
            border-left-color: #ffd700;
            background: linear-gradient(90deg, #fffbea 0%, white 100%);
        }
        .rank {
            font-size: 1.5em;
            font-weight: bold;
            color: #1e3c72;
            min-width: 40px;
        }
        .score {
            font-size: 1.3em;
            font-weight: bold;
            color: #4caf50;
        }

        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #1e3c72;
        }
        .info-box h4 {
            color: #1e3c72;
            margin-bottom: 8px;
        }

        .player-chip {
            display: inline-block;
            background: #e3f2fd;
            color: #1e3c72;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin: 5px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-label {
            font-size: 0.75em;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #1e3c72;
        }

        .budget-bar {
            background: #e0e0e0;
            height: 30px;
            border-radius: 15px;
            margin: 20px 0;
            overflow: hidden;
        }
        .budget-fill {
            background: linear-gradient(90deg, #4caf50 0%, #8bc34a 100%);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
            transition: width 0.3s;
        }

        .scenario {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #1e3c72;
        }
        .scenario h3 {
            color: #333;
            margin-bottom: 10px;
        }
        .scenario p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        .option-btn {
            background: white;
            border: 2px solid #1e3c72;
            color: #333;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            text-align: left;
            font-size: 0.95em;
            transition: all 0.3s;
        }
        .option-btn:hover:not(:disabled) {
            background: #e3f2fd;
            transform: translateX(5px);
        }
        .option-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .option-cost {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 8px;
        }

        .feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }
        .feedback.show { display: block; }
        .feedback.best {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            color: #2e7d32;
        }
        .feedback.good {
            background: #fff9c4;
            border-left: 4px solid #fbc02d;
            color: #f57f17;
        }
        .feedback.poor {
            background: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #1e3c72;
        }

        .timer-container {
            text-align: center;
            margin: 20px 0;
        }
        .timer {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 3em;
            font-weight: bold;
            min-width: 150px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
        }
        .timer.warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            animation: pulse 1s infinite;
        }
        .timer.danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            animation: pulse 0.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .timer-label {
            display: block;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .can-change-vote {
            background: #fff3e0;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
            color: #e65100;
            font-size: 0.9em;
        }

        @media (max-width: 600px) {
            .container { padding: 20px; }
            h1 { font-size: 1.5em; }
            .grid-2 { grid-template-columns: 1fr; }
            .timer { font-size: 2em; padding: 15px 30px; }
        }
    </style>
</head>
<body>
<div class="container">
    <div id="loading-screen" class="loading">
        <h2>Cargando...</h2>
    </div>

    <div id="entry-screen" class="screen">
        <h1>Supply Chain 4.0</h1>
        <p class="subtitle">Modo Multijugador</p>
        <div class="info-box">
            <h4>Como funciona</h4>
            <p>
                1. Crea sala o únete<br>
                2. Forma equipo<br>
                3. Voten dificultad<br>
                4. Compitan por rondas contra el tiempo
            </p>
        </div>
        <div class="grid-2">
            <button class="btn" onclick="showCreateRoom()">Crear Sala</button>
            <button class="btn secondary" onclick="showJoinRoom()">Unirse</button>
        </div>
        <div id="create-room-form" style="display: none;">
            <div class="input-group">
                <label>Nombre Sala:</label>
                <input type="text" id="room-name-input" placeholder="Logistica 101">
            </div>
            <div class="input-group">
                <label>Tu Nombre:</label>
                <input type="text" id="host-name-input" placeholder="Tu nombre">
            </div>
            <button class="btn" onclick="createRoom()">Crear</button>
        </div>
        <div id="join-room-form" style="display: none;">
            <div class="input-group">
                <label>Codigo:</label>
                <input type="text" id="room-code-input" placeholder="ABC123" style="text-transform: uppercase;" maxlength="6">
            </div>
            <div class="input-group">
                <label>Tu Nombre:</label>
                <input type="text" id="player-name-input" placeholder="Tu nombre">
            </div>
            <button class="btn" onclick="joinRoom()">Unirse</button>
        </div>
    </div>

    <div id="lobby-screen" class="screen">
        <h1>Sala: <span id="lobby-room-name">...</span></h1>
        <div class="room-code-display">
            CODIGO: <span id="room-code-display">...</span>
        </div>
        <div class="info-box">
            <h4>Compartir</h4>
            <p>Comparte el código con los demás equipos.</p>
        </div>

        <div id="pre-team-section">
            <h3 style="color: #1e3c72; margin: 20px 0;">Jugadores:</h3>
            <div id="players-waiting-list"></div>

            <div class="input-group">
                <label>Nombre Equipo:</label>
                <input type="text" id="team-name-input" placeholder="Los Logisticos">
            </div>
            <button class="btn" onclick="createTeam()">Crear Equipo</button>

            <div style="margin-top: 30px;">
                <h3 style="color: #1e3c72;">Equipos:</h3>
                <div id="teams-list"></div>
            </div>
        </div>

        <div id="team-formed-section" style="display: none;">
            <h3 style="color: #1e3c72; margin: 20px 0;">
                Tu equipo: <span id="my-team-name"></span>
            </h3>
            <div class="team-card">
                <div id="my-team-members"></div>
            </div>

            <div class="voting-section">
                <h3 style="color: #1e3c72; margin-bottom: 15px;">Vota Dificultad</h3>
                <p style="color: #666; margin-bottom: 10px;">Puedes cambiar tu voto en cualquier momento antes de empezar.</p>
                <div class="vote-option" onclick="vote('easy')">
                    <div>
                        <strong>Principiante</strong><br>
                        <span style="font-size: 0.9em; color: #666;">$800K | 30s por decisión</span>
                    </div>
                    <div class="vote-count" id="votes-easy">0</div>
                </div>
                <div class="vote-option" onclick="vote('normal')">
                    <div>
                        <strong>Normal</strong><br>
                        <span style="font-size: 0.9em; color: #666;">$600K | 25s por decisión</span>
                    </div>
                    <div class="vote-count" id="votes-normal">0</div>
                </div>
                <div class="vote-option" onclick="vote('hard')">
                    <div>
                        <strong>Experto</strong><br>
                        <span style="font-size: 0.9em; color: #666;">$400K | 20s por decisión</span>
                    </div>
                    <div class="vote-count" id="votes-hard">0</div>
                </div>
                <div class="can-change-vote" id="my-vote-display" style="display: none;">
                    Tu voto: <strong id="my-vote-text"></strong>
                </div>
            </div>

            <div class="info-box" id="waiting-message">
                <h4>Esperando...</h4>
                <p>Esperando que todos los equipos voten y se asigne la dificultad.</p>
            </div>

            <button class="btn" id="start-game-btn" onclick="startMultiplayerGame()" style="display: none;">
                Comenzar Ronda 1
            </button>
        </div>

        <div class="leaderboard">
            <h3>Equipos</h3>
            <div id="all-teams-list"></div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <h1>Supply Chain 4.0</h1>
        <p class="subtitle">
            Equipo: <span id="playing-team-name"></span> · Ronda <span id="round-label">1</span>
        </p>
        <div class="timer-container">
            <span class="timer-label">TIEMPO</span>
            <div id="timer" class="timer">--</div>
        </div>

        <div class="budget-bar">
            <div id="budget-fill" class="budget-fill">
                $<span id="budget-text">600</span>K
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Eficiencia</div>
                <div id="efficiency" class="stat-value">65%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Costos</div>
                <div id="costs" class="stat-value">$450K</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Satisfacción</div>
                <div id="satisfaction" class="stat-value">72%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Sostenibilidad</div>
                <div id="sustainability" class="stat-value">60%</div>
            </div>
        </div>

        <div id="scenario-container"></div>
    </div>

    <div id="results-screen" class="screen">
        <h1>Resultados</h1>
        <div class="info-box">
            <h4>Equipo: <span id="results-team-name"></span></h4>
            <p style="font-size: 1.3em; color: #1e3c72; font-weight: bold; margin-top: 10px;">
                Puntos: <span id="results-team-score"></span>
            </p>
            <p style="margin-top: 10px; color: #666;">
                Bonus tiempo: <strong style="color: #4caf50;">+<span id="time-bonus">0</span> pts</strong>
            </p>
        </div>

        <div class="leaderboard">
            <h3>Clasificación final</h3>
            <div id="final-leaderboard"></div>
        </div>

        <button class="btn" onclick="backToLobby()">Volver al lobby</button>
        <button class="btn secondary" onclick="location.reload()">Nueva Sala</button>
    </div>
</div>

<!-- Firebase + Lógica del juego -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
    let db, currentRoom, currentPlayer, currentTeam, roomListener;

    let timerInterval = null;
    let timeRemaining = 0;
    let timeLimit = 0;
    let totalTimeBonus = 0;
    let answerTimeLimit = 0;
    let phase = null; // 'read' o 'answer'

    let currentScenarios = [];
    const READ_TIME = 15;       // segundos para leer la pregunta
    const MAX_ROUNDS = 3;
    let currentRound = 1;

    // =========================
    // BANCO DE ESCENARIOS POR DIFICULTAD
    // =========================
    const scenariosByDifficulty = {
        easy: [
            // 1
            {
                title: "Retraso en proveedor local",
                company: "Pyme Textil",
                description: "Tu principal proveedor de tela anuncia un retraso de 5 días. Tienes inventario limitado en tiendas y se acerca temporada alta.",
                options: [
                    {
                        text: "Redistribuir inventario entre tiendas según ventas históricas",
                        cost: 40,
                        impacts: { efficiency: 10, costs: -15, satisfaction: 8, sustainability: 3 },
                        quality: "best",
                        feedback: "Buena práctica: balanceas inventario usando datos básicos sin disparar costos.",
                        points: 20
                    },
                    {
                        text: "Ordenar producción extra al mismo proveedor pagando hora extra",
                        cost: 80,
                        impacts: { efficiency: 5, costs: 30, satisfaction: 5, sustainability: -2 },
                        quality: "good",
                        feedback: "Funciona, pero incrementa bastante tus costos.",
                        points: 12
                    },
                    {
                        text: "No hacer nada y esperar a que el proveedor se recupere solo",
                        cost: 0,
                        impacts: { efficiency: -10, costs: 0, satisfaction: -12, sustainability: 0 },
                        quality: "poor",
                        feedback: "Pierdes ventas y generas insatisfacción por quiebres de stock.",
                        points: 5
                    },
                    {
                        text: "Buscar un proveedor alterno de emergencia sin revisar calidad",
                        cost: 35,
                        impacts: { efficiency: -2, costs: -5, satisfaction: -8, sustainability: -3 },
                        quality: "poor",
                        feedback: "Respuesta trampa: suena ágil, pero la mala calidad puede afectar tu marca.",
                        points: 6
                    }
                ]
            },
            // 2
            {
                title: "Visibilidad básica de inventarios",
                company: "Retail Regional",
                description: "Tienes tiendas en tres ciudades. Cada tienda maneja su inventario en Excel y hay diferencias entre lo que reportan y lo que realmente tienen.",
                options: [
                    {
                        text: "Centralizar el inventario en un sistema en la nube con actualización diaria",
                        cost: 60,
                        impacts: { efficiency: 12, costs: -20, satisfaction: 10, sustainability: 5 },
                        quality: "best",
                        feedback: "Unificas la información y reduces errores: paso clave hacia Supply Chain 4.0.",
                        points: 22
                    },
                    {
                        text: "Pedir inventarios físicos semanales sin cambiar el sistema",
                        cost: 25,
                        impacts: { efficiency: -3, costs: 5, satisfaction: 2, sustainability: -2 },
                        quality: "good",
                        feedback: "Mejora un poco el control, pero sigues con procesos manuales.",
                        points: 10
                    },
                    {
                        text: "Confiar en el inventario que diga la tienda principal",
                        cost: 5,
                        impacts: { efficiency: -8, costs: 0, satisfaction: -10, sustainability: 0 },
                        quality: "poor",
                        feedback: "Decisión centralizada sin datos confiables aumenta errores.",
                        points: 4
                    },
                    {
                        text: "Implementar sensores IoT en todas las tiendas sin capacitación",
                        cost: 90,
                        impacts: { efficiency: 2, costs: 40, satisfaction: -2, sustainability: 4 },
                        quality: "poor",
                        feedback: "Respuesta trampa: mucha tecnología sin cambio de procesos.",
                        points: 7
                    }
                ]
            },
            // 3
            {
                title: "Transporte de última milla",
                company: "E-commerce Local",
                description: "Tus pedidos en la ciudad llegan en 48–72 horas. La competencia ofrece entregas en 24 horas.",
                options: [
                    {
                        text: "Diseñar rutas básicas por zonas y entregas programadas",
                        cost: 50,
                        impacts: { efficiency: 10, costs: -10, satisfaction: 12, sustainability: 4 },
                        quality: "best",
                        feedback: "Organizas mejor la operación con un esfuerzo razonable.",
                        points: 20
                    },
                    {
                        text: "Ofrecer entregas ultrarrápidas en moto a todos sin recargo",
                        cost: 95,
                        impacts: { efficiency: 10, costs: 40, satisfaction: 15, sustainability: -10 },
                        quality: "good",
                        feedback: "Mejoras experiencia, pero sacrificas margen y sostenibilidad.",
                        points: 14
                    },
                    {
                        text: "Mantener tiempos actuales y hacer una campaña justificando la espera",
                        cost: 10,
                        impacts: { efficiency: 0, costs: 0, satisfaction: -8, sustainability: 0 },
                        quality: "poor",
                        feedback: "La comunicación no compensa el gap de servicio.",
                        points: 5
                    },
                    {
                        text: "Tercerizar la última milla con un operador sin revisar sus indicadores",
                        cost: 45,
                        impacts: { efficiency: -5, costs: -5, satisfaction: -10, sustainability: -3 },
                        quality: "poor",
                        feedback: "Respuesta trampa: puedes empeorar el servicio sin notarlo.",
                        points: 6
                    }
                ]
            },
            // 4
            {
                title: "Almacen desordenado",
                company: "Distribuidora Regional",
                description: "Los tiempos de preparación de pedidos son muy variables. No hay ubicaciones fijas ni etiquetado claro.",
                options: [
                    {
                        text: "Definir ubicaciones fijas y señalización básica por familias de producto",
                        cost: 35,
                        impacts: { efficiency: 14, costs: -5, satisfaction: 8, sustainability: 3 },
                        quality: "best",
                        feedback: "Orden básico que mejora mucho la productividad.",
                        points: 18
                    },
                    {
                        text: "Contratar más auxiliares de almacén sin cambiar el layout",
                        cost: 60,
                        impacts: { efficiency: 4, costs: 25, satisfaction: 4, sustainability: -2 },
                        quality: "good",
                        feedback: "Más manos ayudan, pero el desorden sigue.",
                        points: 10
                    },
                    {
                        text: "Comprar un WMS caro sin documentar procesos actuales",
                        cost: 90,
                        impacts: { efficiency: 3, costs: 35, satisfaction: 2, sustainability: 0 },
                        quality: "poor",
                        feedback: "Respuesta trampa: el sistema no arregla procesos mal diseñados.",
                        points: 7
                    },
                    {
                        text: "Pedir a los operarios que se muevan más rápido",
                        cost: 5,
                        impacts: { efficiency: -3, costs: 0, satisfaction: -5, sustainability: 0 },
                        quality: "poor",
                        feedback: "No atacas la causa raíz, solo generas presión.",
                        points: 4
                    }
                ]
            },
            // 5
            {
                title: "Pronóstico simple de demanda",
                company: "Panadería Industrial",
                description: "Produces diariamente para supermercados. Usas solo promedio de la semana pasada para decidir cantidades.",
                options: [
                    {
                        text: "Agregar patrón de días de la semana (más fin de semana, menos lunes)",
                        cost: 25,
                        impacts: { efficiency: 8, costs: -8, satisfaction: 6, sustainability: 3 },
                        quality: "best",
                        feedback: "Pequeña mejora de analítica que reduce desperdicio.",
                        points: 18
                    },
                    {
                        text: "Duplicar producción los viernes por si acaso",
                        cost: 50,
                        impacts: { efficiency: -4, costs: 20, satisfaction: 4, sustainability: -10 },
                        quality: "poor",
                        feedback: "Respuesta trampa: mucho desperdicio y sobrecosto.",
                        points: 7
                    },
                    {
                        text: "No cambiar nada hasta quejas fuertes de los clientes",
                        cost: 0,
                        impacts: { efficiency: -6, costs: 0, satisfaction: -10, sustainability: -4 },
                        quality: "poor",
                        feedback: "Esperar a la crisis no es buena estrategia.",
                        points: 4
                    },
                    {
                        text: "Instalar sensores IoT en hornos sin usar los datos",
                        cost: 40,
                        impacts: { efficiency: 1, costs: 10, satisfaction: 0, sustainability: 0 },
                        quality: "poor",
                        feedback: "Tecnología sin uso real: otra trampa.",
                        points: 6
                    }
                ]
            },
            // 6
            {
                title: "Devoluciones descontroladas",
                company: "Tienda Online de Moda",
                description: "Las devoluciones han crecido. No tienes visibilidad clara de motivos ni costos. El flujo es manual.",
                options: [
                    {
                        text: "Estandarizar el proceso de devolución y registrar motivos en un formulario digital básico",
                        cost: 30,
                        impacts: { efficiency: 10, costs: -8, satisfaction: 7, sustainability: 4 },
                        quality: "best",
                        feedback: "Mides las causas y puedes mejorar la experiencia.",
                        points: 19
                    },
                    {
                        text: "Ofrecer devoluciones gratis sin restricciones",
                        cost: 80,
                        impacts: { efficiency: -4, costs: 30, satisfaction: 10, sustainability: -8 },
                        quality: "good",
                        feedback: "Clientes felices, pero tu costo se dispara.",
                        points: 12
                    },
                    {
                        text: "Ignorar devoluciones pequeñas para ahorrar tiempo",
                        cost: 0,
                        impacts: { efficiency: 0, costs: 0, satisfaction: -12, sustainability: -3 },
                        quality: "poor",
                        feedback: "Respuesta trampa: deteriora tu reputación.",
                        points: 5
                    },
                    {
                        text: "Delegar todo el proceso a un tercero sin definir indicadores",
                        cost: 45,
                        impacts: { efficiency: -3, costs: 5, satisfaction: -6, sustainability: -2 },
                        quality: "poor",
                        feedback: "Externalizar sin control no te ayuda a aprender.",
                        points: 7
                    }
                ]
            }
        ],

        normal: [
            // 1
            {
                title: "Crisis en canal marítimo",
                company: "2021 – Multinacional de Electrónicos",
                description: "Un bloqueo en una vía marítima clave retrasa tus contenedores. Tienes demanda firme en Europa y acuerdos de servicio exigentes.",
                options: [
                    {
                        text: "Reoptimizar rutas con analítica y priorizar productos críticos",
                        cost: 80,
                        impacts: { efficiency: 18, costs: -35, satisfaction: 14, sustainability: -4 },
                        quality: "best",
                        feedback: "Enfoque 4.0: datos + priorización por criticidad.",
                        points: 26
                    },
                    {
                        text: "Enviar por transporte aéreo solo productos de alta rotación",
                        cost: 120,
                        impacts: { efficiency: 8, costs: 50, satisfaction: 12, sustainability: -18 },
                        quality: "good",
                        feedback: "Usas bien el aire, pero costo y huella suben.",
                        points: 18
                    },
                    {
                        text: "Cambiar todo el volumen a transporte aéreo",
                        cost: 190,
                        impacts: { efficiency: 15, costs: 90, satisfaction: 16, sustainability: -25 },
                        quality: "poor",
                        feedback: "Respuesta trampa: servicio excelente, negocio inviable.",
                        points: 8
                    },
                    {
                        text: "Esperar a que se normalice el canal sin comunicar nada",
                        cost: 5,
                        impacts: { efficiency: -12, costs: 0, satisfaction: -15, sustainability: 2 },
                        quality: "poor",
                        feedback: "La falta de comunicación agrava el impacto.",
                        points: 4
                    }
                ]
            },
            // 2
            {
                title: "IA Predictiva para Inventarios",
                company: "Amazon (Caso Adaptado)",
                description: "Tu empresa quiere pasar de pronósticos por promedio histórico a un modelo más avanzado con datos de demanda, promociones y clima.",
                options: [
                    {
                        text: "Implementar IA que incorpore promociones, clima y tendencias",
                        cost: 100,
                        impacts: { efficiency: 22, costs: -55, satisfaction: 18, sustainability: 10 },
                        quality: "best",
                        feedback: "Conectas múltiples fuentes de datos y mejoras precisión.",
                        points: 28
                    },
                    {
                        text: "Seguir usando solo el año pasado con ajustes por intuición",
                        cost: 10,
                        impacts: { efficiency: -4, costs: 10, satisfaction: -8, sustainability: -6 },
                        quality: "poor",
                        feedback: "No capturas cambios estructurales del mercado.",
                        points: 6
                    },
                    {
                        text: "Comprar un software caro de IA sin integrar tus datos",
                        cost: 120,
                        impacts: { efficiency: 2, costs: 40, satisfaction: 0, sustainability: 0 },
                        quality: "poor",
                        feedback: "Respuesta trampa: tecnología sin datos = cero valor.",
                        points: 7
                    },
                    {
                        text: "Hacer un piloto en una categoría clave y escalar según resultados",
                        cost: 60,
                        impacts: { efficiency: 15, costs: -20, satisfaction: 10, sustainability: 5 },
                        quality: "good",
                        feedback: "Aprendes en pequeño antes de invertir a gran escala.",
                        points: 20
                    }
                ]
            },
            // 3
            {
                title: "Blockchain en Trazabilidad",
                company: "Walmart (Caso Adaptado)",
                description: "Quieren garantizar origen ético de alimentos frescos y responder rápido ante posibles retiros de producto.",
                options: [
                    {
                        text: "Implementar trazabilidad con blockchain desde productor hasta tienda",
                        cost: 95,
                        impacts: { efficiency: 14, costs: -25, satisfaction: 20, sustainability: 16 },
                        quality: "best",
                        feedback: "Transparencia y confianza en toda la cadena.",
                        points: 26
                    },
                    {
                        text: "Mantener PDFs y certificados en correos de proveedores",
                        cost: 15,
                        impacts: { efficiency: -6, costs: 5, satisfaction: -10, sustainability: -4 },
                        quality: "poor",
                        feedback: "Información dispersa y poco confiable.",
                        points: 5
                    },
                    {
                        text: "Usar hojas de cálculo compartidas sin control de cambios",
                        cost: 20,
                        impacts: { efficiency: -2, costs: 0, satisfaction: -6, sustainability: -2 },
                        quality: "poor",
                        feedback: "Respuesta trampa: parece colaborativo pero no robusto.",
                        points: 7
                    },
                    {
                        text: "Exigir auditorías externas periódicas sin mejorar sistemas internos",
                        cost: 55,
                        impacts: { efficiency: 0, costs: 15, satisfaction: 5, sustainability: 4 },
                        quality: "good",
                        feedback: "Mejora algo la confianza pero no es en tiempo real.",
                        points: 16
                    }
                ]
            },
            // 4
            {
                title: "Colaboración con Proveedores",
                company: "Industria de Consumo Masivo",
                description: "Cada proveedor planea por su cuenta. Hay quiebres frecuentes y sobreinventarios al mismo tiempo.",
                options: [
                    {
                        text: "Implementar un proceso CPFR simple con los proveedores clave",
                        cost: 70,
                        impacts: { efficiency: 18, costs: -25, satisfaction: 12, sustainability: 8 },
                        quality: "best",
                        feedback: "Planificación colaborativa que reduce variabilidad.",
                        points: 24
                    },
                    {
                        text: "Imponer penalizaciones fuertes por incumplimiento sin compartir datos",
                        cost: 10,
                        impacts: { efficiency: -4, costs: 0, satisfaction: -5, sustainability: 0 },
                        quality: "poor",
                        feedback: "Respuesta trampa: castigo sin colaboración genera conflicto.",
                        points: 7
                    },
                    {
                        text: "Enviarles tu plan de producción una vez al mes por correo",
                        cost: 20,
                        impacts: { efficiency: 4, costs: -5, satisfaction: 3, sustainability: 2 },
                        quality: "good",
                        feedback: "Es un primer paso, pero poco dinámico.",
                        points: 16
                    },
                    {
                        text: "Dejar que cada proveedor decida sus entregas según su capacidad",
                        cost: 0,
                        impacts: { efficiency: -8, costs: 5, satisfaction: -10, sustainability: -3 },
                        quality: "poor",
                        feedback: "Pierdes control e incrementas variabilidad.",
                        points: 5
                    }
                ]
            },
            // 5
            {
                title: "Nearshoring y Costos",
                company: "Fabricante de Componentes",
                description: "Estás evaluando mover parte de la producción a un país cercano para reducir tiempos, pero con mayor costo laboral.",
                options: [
                    {
                        text: "Simular escenarios de nearshoring considerando demanda, tiempos y costo total",
                        cost: 90,
                        impacts: { efficiency: 16, costs: -18, satisfaction: 12, sustainability: 10 },
                        quality: "best",
                        feedback: "Analítica de red para decidir con información completa.",
                        points: 27
                    },
                    {
                        text: "Decidir solo por costo laboral más bajo sin mirar tiempos",
                        cost: 20,
                        impacts: { efficiency: -6, costs: -5, satisfaction: -10, sustainability: -4 },
                        quality: "poor",
                        feedback: "Respuesta trampa: optimizas un solo eje y empeoras el resto.",
                        points: 6
                    },
                    {
                        text: "Mantener toda la producción lejana y aumentar inventarios de seguridad",
                        cost: 60,
                        impacts: { efficiency: -4, costs: 25, satisfaction: 6, sustainability: -8 },
                        quality: "poor",
                        feedback: "Más inventario no compensa tiempos demasiado largos.",
                        points: 8
                    },
                    {
                        text: "Hacer un piloto con una parte del portafolio y comparar KPIs",
                        cost: 55,
                        impacts: { efficiency: 10, costs: -10, satisfaction: 8, sustainability: 6 },
                        quality: "good",
                        feedback: "Aprendes en pequeño antes de mover toda la red.",
                        points: 20
                    }
                ]
            },
            // 6
            {
                title: "Plan Maestro de Producción",
                company: "Empresa de Alimentos Empacados",
                description: "Las áreas de ventas y producción no se alinean. Hay campañas comerciales que nadie comunica a planta.",
                options: [
                    {
                        text: "Implementar un proceso S&OP mensual con datos y consenso entre áreas",
                        cost: 85,
                        impacts: { efficiency: 20, costs: -22, satisfaction: 14, sustainability: 8 },
                        quality: "best",
                        feedback: "Proceso formal de planificación integrada.",
                        points: 28
                    },
                    {
                        text: "Dejar que ventas defina volúmenes y producción se adapte como pueda",
                        cost: 10,
                        impacts: { efficiency: -6, costs: 10, satisfaction: -8, sustainability: -4 },
                        quality: "poor",
                        feedback: "Respuesta trampa: desorden garantizado.",
                        points: 6
                    },
                    {
                        text: "Agregar capacidad temporal alquilando una planta externa",
                        cost: 70,
                        impacts: { efficiency: 8, costs: 25, satisfaction: 10, sustainability: -6 },
                        quality: "good",
                        feedback: "Ayuda a responder, pero sin proceso te puedes pasar.",
                        points: 18
                    },
                    {
                        text: "Pedir a ventas que reduzca promociones sin analizar impacto",
                        cost: 0,
                        impacts: { efficiency: 0, costs: 0, satisfaction: -10, sustainability: 0 },
                        quality: "poor",
                        feedback: "Medida reactiva sin análisis de rentabilidad.",
                        points: 7
                    }
                ]
            }
        ],

        hard: [
            // 1
            {
                title: "Rediseño de Red post-Crisis Global",
                company: "Multinacional Farmacéutica",
                description: "Tras una pandemia, tu red está sobredimensionada en algunos países y frágil en otros. Debes rediseñarla usando enfoques 4.0.",
                longCase: true,
                options: [
                    {
                        text: "Diseñar red multimodal apoyada en gemelos digitales y simulación",
                        cost: 110,
                        impacts: { efficiency: 22, costs: -45, satisfaction: 18, sustainability: 12 },
                        quality: "best",
                        feedback: "Usas gemelos digitales para balancear costo, servicio y riesgo.",
                        points: 34
                    },
                    {
                        text: "Cerrar DCs solo donde el costo operativo es más alto",
                        cost: 55,
                        impacts: { efficiency: -4, costs: -20, satisfaction: -6, sustainability: 0 },
                        quality: "poor",
                        feedback: "Respuesta trampa: miras solo costo, ignoras resiliencia.",
                        points: 10
                    },
                    {
                        text: "Mantener la red actual y solo aumentar inventarios de seguridad",
                        cost: 80,
                        impacts: { efficiency: -6, costs: 35, satisfaction: 6, sustainability: -8 },
                        quality: "poor",
                        feedback: "Más stock no arregla diseño frágil.",
                        points: 8
                    },
                    {
                        text: "Centralizar decisiones en la casa matriz sin analítica local",
                        cost: 30,
                        impacts: { efficiency: -10, costs: 5, satisfaction: -12, sustainability: -4 },
                        quality: "poor",
                        feedback: "Pierdes la riqueza de la información local.",
                        points: 6
                    }
                ]
            },
            // 2
            {
                title: "Orquestación de Datos en Tiempo Real",
                company: "Operador Logístico Global",
                description: "Tienes sistemas heredados, sensores IoT, datos de clima y tráfico, pero todo está desconectado.",
                options: [
                    {
                        text: "Crear una plataforma de datos unificada y tableros de control en tiempo real",
                        cost: 120,
                        impacts: { efficiency: 24, costs: -40, satisfaction: 20, sustainability: 10 },
                        quality: "best",
                        feedback: "Integras fuentes y habilitas decisiones en tiempo real.",
                        points: 36
                    },
                    {
                        text: "Agregar más sensores IoT sin integrar con sistemas existentes",
                        cost: 70,
                        impacts: { efficiency: 2, costs: 20, satisfaction: 0, sustainability: 3 },
                        quality: "poor",
                        feedback: "Respuesta trampa: más datos sin integración = más ruido.",
                        points: 9
                    },
                    {
                        text: "Contratar analistas para revisar reportes diarios en Excel",
                        cost: 45,
                        impacts: { efficiency: -2, costs: 10, satisfaction: 4, sustainability: 0 },
                        quality: "good",
                        feedback: "Mejora algo, pero sigues reaccionando tarde.",
                        points: 16
                    },
                    {
                        text: "Usar solo la experiencia de los planificadores senior",
                        cost: 15,
                        impacts: { efficiency: -8, costs: 0, satisfaction: -6, sustainability: 0 },
                        quality: "poor",
                        feedback: "No escalable ni replicable: puro riesgo.",
                        points: 7
                    }
                ]
            },
            // 3
            {
                title: "Sostenibilidad vs Servicio en Cadena Global",
                company: "Marca de Moda Internacional",
                description: "La compañía quiere reducir su huella de carbono manteniendo tiempos de entrega competitivos en varios continentes.",
                options: [
                    {
                        text: "Optimizar la red combinando hubs regionales, marítimo y aéreo solo para urgencias",
                        cost: 105,
                        impacts: { efficiency: 20, costs: -30, satisfaction: 16, sustainability: 22 },
                        quality: "best",
                        feedback: "Equilibras servicio, costo y sostenibilidad.",
                        points: 35
                    },
                    {
                        text: "Cambiar todo el transporte a marítimo para reducir CO₂",
                        cost: 70,
                        impacts: { efficiency: -12, costs: -20, satisfaction: -18, sustainability: 25 },
                        quality: "poor",
                        feedback: "Respuesta trampa: servicio pésimo, clientes se van.",
                        points: 9
                    },
                    {
                        text: "Compensar huella plantando árboles sin cambiar la red",
                        cost: 50,
                        impacts: { efficiency: 0, costs: 10, satisfaction: 4, sustainability: 8 },
                        quality: "good",
                        feedback: "Ayuda, pero no toca la causa raíz.",
                        points: 18
                    },
                    {
                        text: "Subir precios para cubrir soluciones verdes sin comunicar el valor",
                        cost: 30,
                        impacts: { efficiency: 0, costs: 0, satisfaction: -10, sustainability: 5 },
                        quality: "poor",
                        feedback: "El cliente no entiende y abandona la marca.",
                        points: 6
                    }
                ]
            },
            // 4
            {
                title: "Planificación de Capacidad Global",
                company: "Fabricante de Equipos Industriales",
                description: "Tus plantas en Asia, Europa y América tienen distintos niveles de utilización. El lead time global es muy largo.",
                options: [
                    {
                        text: "Construir un gemelo digital de capacidad y simular reasignación de productos",
                        cost: 115,
                        impacts: { efficiency: 22, costs: -25, satisfaction: 14, sustainability: 10 },
                        quality: "best",
                        feedback: "Herramienta avanzada para balancear carga entre plantas.",
                        points: 34
                    },
                    {
                        text: "Agregar turnos extra en la planta más barata",
                        cost: 60,
                        impacts: { efficiency: 6, costs: 20, satisfaction: 6, sustainability: -4 },
                        quality: "good",
                        feedback: "Ayuda algo, pero no cuestiona el diseño completo.",
                        points: 18
                    },
                    {
                        text: "Cerrar la planta menos utilizada sin análisis de red",
                        cost: 20,
                        impacts: { efficiency: -8, costs: -10, satisfaction: -6, sustainability: -2 },
                        quality: "poor",
                        feedback: "Respuesta trampa: puedes crear cuellos de botella nuevos.",
                        points: 8
                    },
                    {
                        text: "Decidir capacidad solo en función del histórico de los últimos 3 meses",
                        cost: 10,
                        impacts: { efficiency: -4, costs: 0, satisfaction: -4, sustainability: 0 },
                        quality: "poor",
                        feedback: "Ventana demasiado corta, muy reactiva.",
                        points: 7
                    }
                ]
            },
            // 5
            {
                title: "Riesgo Geopolítico en Proveedores Críticos",
                company: "Electrónica de Consumo",
                description: "El 80% de tus componentes clave viene de una sola región con inestabilidad política.",
                options: [
                    {
                        text: "Diseñar y ejecutar una estrategia de multi-sourcing con análisis de riesgo",
                        cost: 100,
                        impacts: { efficiency: 14, costs: -10, satisfaction: 10, sustainability: 6 },
                        quality: "best",
                        feedback: "Reduces riesgo sin perder competitividad.",
                        points: 32
                    },
                    {
                        text: "Aumentar inventario de seguridad solo de esos componentes",
                        cost: 75,
                        impacts: { efficiency: -4, costs: 30, satisfaction: 6, sustainability: -8 },
                        quality: "good",
                        feedback: "Solución parcial y costosa.",
                        points: 18
                    },
                    {
                        text: "Confiar en contratos actuales y esperar que no pase nada",
                        cost: 0,
                        impacts: { efficiency: 0, costs: 0, satisfaction: -10, sustainability: 0 },
                        quality: "poor",
                        feedback: "Respuesta trampa: altísima exposición al riesgo.",
                        points: 6
                    },
                    {
                        text: "Mover todo el volumen a un proveedor alterno sin validar su capacidad",
                        cost: 55,
                        impacts: { efficiency: -6, costs: 5, satisfaction: -8, sustainability: -2 },
                        quality: "poor",
                        feedback: "Cambias riesgo geopolítico por riesgo operativo.",
                        points: 8
                    }
                ]
            },
            // 6
            {
                title: "Estrategia Omnicanal Avanzada",
                company: "Retail Global",
                description: "Tus clientes compran en web, app y tienda física. La promesa de entrega cambia según el canal y genera confusión.",
                options: [
                    {
                        text: "Unificar inventario disponible por canal y promesas de entrega con un motor de orquestación",
                        cost: 120,
                        impacts: { efficiency: 20, costs: -18, satisfaction: 18, sustainability: 8 },
                        quality: "best",
                        feedback: "Verdadera omnicanalidad orquestada en tiempo real.",
                        points: 35
                    },
                    {
                        text: "Priorizar siempre el canal online y dejar la tienda como respaldo",
                        cost: 40,
                        impacts: { efficiency: 4, costs: 5, satisfaction: -6, sustainability: 0 },
                        quality: "poor",
                        feedback: "Respuesta trampa: descuidas la experiencia física.",
                        points: 10
                    },
                    {
                        text: "Separar inventario por canal para simplificar operaciones",
                        cost: 65,
                        impacts: { efficiency: -4, costs: 15, satisfaction: 2, sustainability: -3 },
                        quality: "poor",
                        feedback: "Pierdes flexibilidad y aumentas stock.",
                        points: 9
                    },
                    {
                        text: "Implementar recogida en tienda (click & collect) integrando sistemas",
                        cost: 80,
                        impacts: { efficiency: 10, costs: -8, satisfaction: 12, sustainability: 5 },
                        quality: "good",
                        feedback: "Paso intermedio sólido hacia omnicanalidad.",
                        points: 22
                    }
                ]
            }
        ]
    };

    // Caso final (común a todas las dificultades)
    const finalCase = {
        title: "Caso Final: Expansión a Sudamérica",
        description: "Tu empresa opera con un sistema relativamente estable en Norteamérica. Ahora quiere expandirse a Sudamérica, donde la infraestructura es limitada, la demanda es volátil y los clientes son muy sensibles a tiempos de entrega.",
        question: "¿Cuál estrategia refleja mejor una Supply Chain 4.0 adaptada al nuevo contexto?",
        options: [
            {
                text: "Replicar el sistema actual y usar los mismos distribuidores tradicionales",
                points: 25,
                feedback: "Conservador: puedes operar, pero no aprovechas flexibilidad ni analítica.",
                isCorrect: false
            },
            {
                text: "Usar nube + IoT para visibilidad, alianzas locales, IA para rutas y analítica de demanda",
                points: 50,
                feedback: "Excelente: red adaptativa, conectada y basada en datos.",
                isCorrect: true
            },
            {
                text: "Crear mega-almacenes propios y mover el 60% por transporte aéreo",
                points: 15,
                feedback: "Muy costoso e insostenible a largo plazo, aunque rápido.",
                isCorrect: false
            },
            {
                text: "Ir solo con e-commerce sin presencia física ni socios locales",
                points: 20,
                feedback: "Cobertura y tiempos de entrega limitados.",
                isCorrect: false
            }
        ]
    };

    // Estado del juego
    let gameState = {
        currentScenario: 0,
        efficiency: 65,
        costs: 450,
        satisfaction: 72,
        sustainability: 60,
        budget: 600,
        maxBudget: 600,
        score: 0
    };

    function resetGameState() {
        gameState = {
            currentScenario: 0,
            efficiency: 65,
            costs: 450,
            satisfaction: 72,
            sustainability: 60,
            budget: 600,
            maxBudget: 600,
            score: 0
        };
    }

    // =========================
    // INIT FIREBASE
    // =========================
    function initApp() {
        try {
            if (typeof firebase === 'undefined') {
                document.getElementById('loading-screen').innerHTML = '<h2 style="color: red;">Error Firebase</h2>';
                return;
            }
            firebase.initializeApp({
                apiKey: "AIzaSyDIUt20W8U7cUDqyfLYxqrs2-pNwTodvi4",
                authDomain: "supply-chain-game-f1bc4.firebaseapp.com",
                databaseURL: "https://supply-chain-game-f1bc4-default-rtdb.firebaseio.com",
                projectId: "supply-chain-game-f1bc4",
                storageBucket: "supply-chain-game-f1bc4.firebasestorage.app",
                messagingSenderId: "992566402291",
                appId: "1:992566402291:web:3a699f86b04cca816eab86"
            });
            db = firebase.database();
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('entry-screen').classList.add('active');
        } catch (e) {
            document.getElementById('loading-screen').innerHTML = '<h2 style="color: red;">Error: ' + e.message + '</h2>';
        }
    }

    window.addEventListener('load', () => setTimeout(initApp, 500));

    // =========================
    // UI ENTRADA / SALA
    // =========================
    function showCreateRoom() {
        document.getElementById('create-room-form').style.display = 'block';
        document.getElementById('join-room-form').style.display = 'none';
    }
    function showJoinRoom() {
        document.getElementById('join-room-form').style.display = 'block';
        document.getElementById('create-room-form').style.display = 'none';
    }

    function createRoom() {
        const roomName = document.getElementById('room-name-input').value.trim();
        const hostName = document.getElementById('host-name-input').value.trim();
        if (!roomName || !hostName) {
            alert('Completa campos');
            return;
        }
        const roomCode = generateRoomCode();
        currentPlayer = { name: hostName, id: generateId() };
        currentRoom = {
            code: roomCode,
            name: roomName,
            host: currentPlayer.id,
            players: {},
            teams: {},
            votes: {},
            difficulty: null,
            status: 'lobby',
            createdAt: Date.now()
        };
        currentRoom.players[currentPlayer.id] = currentPlayer;
        db.ref('rooms/' + roomCode).set(currentRoom)
            .then(() => {
                listenToRoom(roomCode);
                showLobby();
            })
            .catch(err => alert('Error: ' + err.message));
    }

    function joinRoom() {
        const roomCode = document.getElementById('room-code-input').value.trim().toUpperCase();
        const playerName = document.getElementById('player-name-input').value.trim();
        if (!roomCode || !playerName) {
            alert('Completa campos');
            return;
        }
        currentPlayer = { name: playerName, id: generateId() };
        db.ref('rooms/' + roomCode).once('value').then(snapshot => {
            if (snapshot.exists()) {
                currentRoom = snapshot.val();
                db.ref('rooms/' + roomCode + '/players/' + currentPlayer.id).set(currentPlayer)
                    .then(() => {
                        listenToRoom(roomCode);
                        showLobby();
                    });
            } else alert('Código no existe');
        }).catch(err => alert('Error: ' + err.message));
    }

    function createTeam() {
        const teamName = document.getElementById('team-name-input').value.trim();
        if (!teamName) {
            alert('Nombre equipo');
            return;
        }
        const teamId = generateId();
        currentTeam = {
            id: teamId,
            name: teamName,
            members: [currentPlayer.id],
            status: 'waiting',
            score: 0,
            timeBonus: 0,
            createdAt: Date.now()
        };
        db.ref('rooms/' + currentRoom.code + '/teams/' + teamId).set(currentTeam).then(() => {
            document.getElementById('pre-team-section').style.display = 'none';
            document.getElementById('team-formed-section').style.display = 'block';
        });
    }

    function joinTeam(teamId) {
        const team = currentRoom.teams[teamId];
        if (team && !team.members.includes(currentPlayer.id)) {
            team.members.push(currentPlayer.id);
            currentTeam = team;
            db.ref('rooms/' + currentRoom.code + '/teams/' + teamId + '/members').set(team.members).then(() => {
                document.getElementById('pre-team-section').style.display = 'none';
                document.getElementById('team-formed-section').style.display = 'block';
            });
        }
    }

    function vote(difficulty) {
        if (!currentTeam) return;
        db.ref('rooms/' + currentRoom.code + '/votes/' + currentTeam.id).set(difficulty);
        updateMyVoteDisplay(difficulty);
    }

    function updateMyVoteDisplay(difficulty) {
        const displayDiv = document.getElementById('my-vote-display');
        const textSpan = document.getElementById('my-vote-text');
        const labels = { easy: 'Principiante', normal: 'Normal', hard: 'Experto' };
        textSpan.textContent = labels[difficulty];
        displayDiv.style.display = 'block';
    }

    function listenToRoom(roomCode) {
        roomListener = db.ref('rooms/' + roomCode).on('value', snapshot => {
            if (snapshot.exists()) {
                currentRoom = snapshot.val();
                updateLobby();
                checkIfAllVoted();
            }
        });
    }

    function checkIfAllVoted() {
        if (!currentRoom || !currentRoom.teams) return;
        const allTeams = Object.values(currentRoom.teams);
        if (allTeams.length === 0) return;

        const allVoted = allTeams.every(team => currentRoom.votes && currentRoom.votes[team.id]);
        if (allVoted && !currentRoom.difficulty) {
            const voteCounts = { easy: 0, normal: 0, hard: 0 };
            Object.values(currentRoom.votes).forEach(v => voteCounts[v]++);
            let winningDifficulty = 'normal', maxVotes = 0;
            Object.entries(voteCounts).forEach(([diff, count]) => {
                if (count > maxVotes) {
                    maxVotes = count;
                    winningDifficulty = diff;
                }
            });
            db.ref('rooms/' + currentRoom.code + '/difficulty').set(winningDifficulty);
        }

        if (currentRoom.difficulty && currentTeam) {
            document.getElementById('waiting-message').style.display = 'none';
            document.getElementById('start-game-btn').style.display = 'block';
        }
    }

    function showLobby() {
        document.getElementById('entry-screen').classList.remove('active');
        document.getElementById('lobby-screen').classList.add('active');
        document.getElementById('lobby-room-name').textContent = currentRoom.name;
        document.getElementById('room-code-display').textContent = currentRoom.code;
        updateLobby();
    }

    function updateLobby() {
        if (!currentRoom) return;

        const playersWithoutTeam = Object.values(currentRoom.players || {}).filter(player =>
            !Object.values(currentRoom.teams || {}).some(team => team.members && team.members.includes(player.id))
        );
        let playersHTML = '';
        playersWithoutTeam.forEach(player => playersHTML += '<span class="player-chip">' + player.name + '</span>');
        document.getElementById('players-waiting-list').innerHTML = playersHTML || '<p style="color: #666;">Todos en equipos</p>';

        let teamsHTML = '';
        Object.values(currentRoom.teams || {}).forEach(team => {
            const isMyTeam = currentTeam && currentTeam.id === team.id;
            const canJoin = !isMyTeam && currentPlayer && !team.members.includes(currentPlayer.id);
            teamsHTML +=
                '<div class="team-card ' + (isMyTeam ? 'selected' : '') + '" ' +
                (canJoin ? 'onclick="joinTeam(\'' + team.id + '\')"' : '') + '>' +
                '<div class="team-name">' + team.name + (isMyTeam ? ' (Tu equipo)' : '') + '</div>' +
                '<div style="color: #666;">' + team.members.length + ' miembro(s)</div></div>';
        });
        document.getElementById('teams-list').innerHTML = teamsHTML || '<p style="color: #666;">No hay equipos</p>';

        if (currentTeam && currentRoom.teams && currentRoom.teams[currentTeam.id]) {
            const updatedTeam = currentRoom.teams[currentTeam.id];
            document.getElementById('my-team-name').textContent = updatedTeam.name;
            let membersHTML = '';
            updatedTeam.members.forEach(memberId => {
                const member = currentRoom.players[memberId];
                if (member) membersHTML += '<span class="player-chip">' + member.name + '</span>';
            });
            document.getElementById('my-team-members').innerHTML = membersHTML;
        }

        let allTeamsHTML = '';
        Object.values(currentRoom.teams || {}).forEach(team => {
            allTeamsHTML +=
                '<div class="leaderboard-item">' +
                '<div class="rank">' + team.members.length + '</div>' +
                '<div style="flex: 1; margin: 0 15px;"><strong>' + team.name + '</strong></div>' +
                (team.score > 0 ? '<div class="score">' + team.score + '</div>' : '<div style="color: #999;">---</div>') +
                '</div>';
        });
        document.getElementById('all-teams-list').innerHTML = allTeamsHTML || '<p style="text-align: center; color: #666;">Sin equipos</p>';

        if (!currentRoom || !currentRoom.votes) return;
        const voteCounts = { easy: 0, normal: 0, hard: 0 };
        Object.values(currentRoom.votes).forEach(vote => voteCounts[vote]++);
        document.getElementById('votes-easy').textContent = voteCounts.easy;
        document.getElementById('votes-normal').textContent = voteCounts.normal;
        document.getElementById('votes-hard').textContent = voteCounts.hard;

        if (currentTeam && currentRoom.votes && currentRoom.votes[currentTeam.id]) {
            updateMyVoteDisplay(currentRoom.votes[currentTeam.id]);
        }
    }

    // =========================
    // LÓGICA DE RONDAS + CONFIG INICIAL
    // =========================
    function getScenariosForRound(difficulty, round) {
        const pool = scenariosByDifficulty[difficulty] || [];
        const casesPerRound = 2; // 2 casos por ronda -> 3 rondas = 6 casos por dificultad
        const start = (round - 1) * casesPerRound;
        return pool.slice(start, start + casesPerRound);
    }

    function startMultiplayerGame() {
        const difficulties = {
            easy: { budget: 800, time: 30 },
            normal: { budget: 600, time: 25 },
            hard: { budget: 400, time: 20 }
        };

        const config = difficulties[currentRoom.difficulty] || difficulties.normal;

        // Reinicio de estado
        resetGameState();
        currentRound = 1;
        currentScenarios = getScenariosForRound(currentRoom.difficulty, currentRound);

        gameState.budget = config.budget;
        gameState.maxBudget = config.budget;
        timeLimit = config.time;

        // Tiempo para responder: tiempo original - 10s (mínimo 5)
        answerTimeLimit = Math.max(5, timeLimit - 10);

        totalTimeBonus = 0;

        db.ref('rooms/' + currentRoom.code + '/teams/' + currentTeam.id + '/status').set('playing');
        showGame();
    }

    // =========================
    // TIMER CON FASE LECTURA + RESPUESTA
    // =========================
    function startReadingPhase() {
        phase = 'read';
        timeRemaining = READ_TIME;
        updateTimerDisplay();

        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay();

            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;

                const optionsEl = document.getElementById('options-container');
                if (optionsEl) optionsEl.style.display = 'flex';

                startAnswerPhase();
            }
        }, 1000);
    }

    function startAnswerPhase() {
        phase = 'answer';
        timeRemaining = answerTimeLimit;
        updateTimerDisplay();

        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay();
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                handleTimeout();
            }
        }, 1000);
    }

    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }

    function updateTimerDisplay() {
        const timerEl = document.getElementById('timer');
        if (!timerEl) return;

        timerEl.textContent = timeRemaining + 's';
        timerEl.className = 'timer';

        if (phase === 'answer') {
            if (timeRemaining <= 5) timerEl.classList.add('danger');
            else if (timeRemaining <= 10) timerEl.classList.add('warning');
        }
    }

    function handleTimeout() {
        document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
        const feedbackDiv = document.getElementById('feedback');
        if (!feedbackDiv) return;

        feedbackDiv.className = 'feedback show poor';
        feedbackDiv.innerHTML = '<strong>Tiempo agotado!</strong><p>0 puntos</p>';
        setTimeout(() => feedbackDiv.innerHTML += '<button class="btn" onclick="nextScenario()">Continuar</button>', 2000);
    }

    // =========================
    // ESCENARIOS Y RONDAS
    // =========================
    function showGame() {
        document.getElementById('lobby-screen').classList.remove('active');
        document.getElementById('game-screen').classList.add('active');
        document.getElementById('playing-team-name').textContent = currentTeam.name;
        document.getElementById('round-label').textContent = currentRound;
        updateStats();
        loadScenario(0);
    }

    function loadScenario(index) {
        if (index >= currentScenarios.length) {
            // Si ya no hay más casos en esta ronda, manejamos el fin de ronda en nextScenario
            return;
        }

        gameState.currentScenario = index;
        const scenario = currentScenarios[index];

        let html =
            '<div class="scenario">' +
            '<h3>' + scenario.title + '</h3>' +
            '<p style="color: #666;">' + (scenario.company || '') + '</p>' +
            '<p>' + scenario.description + '</p>' +
            '<div class="options" id="options-container">';

        scenario.options.forEach((option, i) => {
            const disabled = option.cost > gameState.budget ? 'disabled' : '';
            html +=
                '<button class="option-btn" onclick="selectOption(' + index + ', ' + i + ')" ' + disabled + '>' +
                option.text +
                '<span class="option-cost">$' + option.cost + 'K</span></button>';
        });

        html += '</div><div id="feedback" class="feedback"></div></div>';

        document.getElementById('scenario-container').innerHTML = html;

        const optionsEl = document.getElementById('options-container');

        if (scenario.longCase) {
            // Casos largos: sin fase de lectura, tiempo completo original
            if (optionsEl) optionsEl.style.display = 'flex';
            const originalAnswerTime = answerTimeLimit;
            answerTimeLimit = timeLimit;
            startAnswerPhase();
            answerTimeLimit = originalAnswerTime;
        } else {
            // Casos normales: primero solo lectura, luego respuesta
            if (optionsEl) optionsEl.style.display = 'none';
            startReadingPhase();
        }
    }

    function selectOption(scenarioIndex, optionIndex) {
        const scenario = currentScenarios[scenarioIndex];
        const option = scenario.options[optionIndex];
        if (option.cost > gameState.budget) return;

        stopTimer();
        const timeBonus = Math.max(0, timeRemaining);
        if (phase === 'answer') {
            totalTimeBonus += timeBonus;
        }

        document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);

        gameState.budget -= option.cost;
        Object.keys(option.impacts).forEach(key => {
            gameState[key] += option.impacts[key];
        });
        gameState.score += option.points + (phase === 'answer' ? timeBonus : 0);

        updateStats();

        const feedbackDiv = document.getElementById('feedback');
        feedbackDiv.className = 'feedback show ' + option.quality;
        feedbackDiv.innerHTML =
            '<strong>' +
            (option.quality === 'best' ? 'Excelente!' : option.quality === 'good' ? 'Buena' : 'Subóptima') +
            '</strong><p>' + option.feedback + '</p>' +
            '<p><strong>Puntos:</strong> +' + option.points + '</p>';

        if (phase === 'answer') {
            feedbackDiv.innerHTML +=
                '<p style="color: #4caf50;"><strong>Bonus tiempo:</strong> +' + timeBonus + '</p>';
        }

        setTimeout(() => {
            const isLastScenario = (scenarioIndex >= currentScenarios.length - 1);
            const buttonText =
                (currentRound < MAX_ROUNDS && isLastScenario) ? 'Siguiente Ronda' :
                (currentRound === MAX_ROUNDS && isLastScenario) ? 'Caso Final' :
                'Siguiente';

            const nextAction =
                (currentRound < MAX_ROUNDS && isLastScenario) ? 'endRound()' :
                (currentRound === MAX_ROUNDS && isLastScenario) ? 'nextScenario()' :
                'nextScenario()';

            feedbackDiv.innerHTML += '<button class="btn" onclick="' + nextAction + '">' + buttonText + '</button>';
        }, 1500);
    }

    function nextScenario() {
        const lastIndex = currentScenarios.length - 1;
        if (gameState.currentScenario < lastIndex) {
            loadScenario(gameState.currentScenario + 1);
        } else {
            if (currentRound < MAX_ROUNDS) {
                endRound();
            } else {
                loadFinalCase();
            }
        }
    }

    function endRound() {
        stopTimer();
        const scenarioContainer = document.getElementById('scenario-container');
        scenarioContainer.innerHTML =
            '<div class="scenario">' +
            '<h3>Ronda ' + currentRound + ' completada</h3>' +
            '<p>Buen trabajo. Tus decisiones y puntaje acumulado te llevan a la siguiente ronda.</p>' +
            '<p style="margin-top: 10px;"><strong>Puntaje acumulado:</strong> ' + Math.round(gameState.score) + ' pts</p>' +
            '<button class="btn" style="margin-top: 20px;" onclick="startNextRound()">Continuar a la Ronda ' + (currentRound + 1) + '</button>' +
            '</div>';
    }

    function startNextRound() {
        if (currentRound >= MAX_ROUNDS) return;
        currentRound++;
        document.getElementById('round-label').textContent = currentRound;
        currentScenarios = getScenariosForRound(currentRoom.difficulty, currentRound);
        loadScenario(0);
    }

    // =========================
    // CASO FINAL
    // =========================
    function loadFinalCase() {
        stopTimer();
        phase = null;

        let html =
            '<div class="scenario">' +
            '<h3>' + finalCase.title + '</h3>' +
            '<div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 3px solid #ff9800;">' +
            '<strong>CONTEXTO:</strong>' +
            '<p style="margin-top: 10px;">' + finalCase.description + '</p>' +
            '</div>' +
            '<p style="font-weight: bold; font-size: 1.1em; margin-top: 15px;">' + finalCase.question + '</p>' +
            '<div class="info-box" style="background: #fff3e0; border-left-color: #ff9800;">' +
            '<p style="color: #e65100; font-weight: bold;">SIN TIEMPO - Analiza bien</p>' +
            '</div>' +
            '<div class="options">';

        finalCase.options.forEach((option, i) => {
            html += '<button class="option-btn" onclick="selectFinalOption(' + i + ')" style="padding: 20px;">' +
                option.text + '</button>';
        });

        html += '</div><div id="feedback" class="feedback"></div></div>';
        document.getElementById('scenario-container').innerHTML = html;

        const timerEl = document.getElementById('timer');
        timerEl.textContent = '∞';
        timerEl.className = 'timer';
    }

    function selectFinalOption(optionIndex) {
        const option = finalCase.options[optionIndex];
        stopTimer();

        document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
        gameState.score += option.points;
        updateStats();

        const feedbackDiv = document.getElementById('feedback');
        feedbackDiv.className = 'feedback show ' + (option.isCorrect ? 'best' : 'poor');
        feedbackDiv.innerHTML =
            '<strong>' + (option.isCorrect ? 'CORRECTO!' : 'No óptima') + '</strong>' +
            '<p>' + option.feedback + '</p>' +
            '<p><strong>Puntos:</strong> +' + option.points + '</p>';

        setTimeout(() => feedbackDiv.innerHTML += '<button class="btn" onclick="endGame()">Ver Resultados</button>', 2000);
    }

    // =========================
    // ESTADÍSTICAS Y RESULTADOS
    // =========================
    function updateStats() {
        gameState.efficiency = Math.max(0, Math.min(100, gameState.efficiency));
        gameState.satisfaction = Math.max(0, Math.min(100, gameState.satisfaction));
        gameState.sustainability = Math.max(0, Math.min(100, gameState.sustainability));

        document.getElementById('efficiency').textContent = Math.round(gameState.efficiency) + '%';
        document.getElementById('costs').textContent = '$' + gameState.costs + 'K';
        document.getElementById('satisfaction').textContent = Math.round(gameState.satisfaction) + '%';
        document.getElementById('sustainability').textContent = Math.round(gameState.sustainability) + '%';
        document.getElementById('budget-text').textContent = gameState.budget;
        document.getElementById('budget-fill').style.width = ((gameState.budget / gameState.maxBudget) * 100) + '%';
    }

    function endGame() {
        stopTimer();
        const avgMetrics = (gameState.efficiency + gameState.satisfaction + gameState.sustainability) / 3;
        const finalScore = Math.round(gameState.score + avgMetrics);

        db.ref('rooms/' + currentRoom.code + '/teams/' + currentTeam.id).update({
            score: finalScore,
            timeBonus: totalTimeBonus,
            status: 'finished'
        }).then(() => showResults());
    }

    function showResults() {
        document.getElementById('game-screen').classList.remove('active');
        document.getElementById('results-screen').classList.add('active');
        document.getElementById('results-team-name').textContent = currentTeam.name;
        document.getElementById('time-bonus').textContent = totalTimeBonus;

        db.ref('rooms/' + currentRoom.code + '/teams/' + currentTeam.id + '/score').once('value').then(snapshot => {
            document.getElementById('results-team-score').textContent = (snapshot.val() || 0) + ' pts';
        });

        db.ref('rooms/' + currentRoom.code + '/teams').once('value').then(snapshot => {
            const teams = snapshot.val() || {};
            const sortedTeams = Object.values(teams)
                .filter(team => team.status === 'finished')
                .sort((a, b) => (b.score || 0) - (a.score || 0));

            let html = '';
            sortedTeams.forEach((team, index) => {
                const rankClass = index === 0 ? 'first' : '';
                const medal = ['🥇', '🥈', '🥉'][index] || (index + 1);
                html +=
                    '<div class="leaderboard-item ' + rankClass + '">' +
                    '<div class="rank">' + medal + '</div>' +
                    '<div style="flex: 1; margin: 0 15px;"><strong>' + team.name +
                    '</strong><br><small style="color: #666;">Bonus: +' + (team.timeBonus || 0) + ' pts</small></div>' +
                    '<div class="score">' + (team.score || 0) + '</div></div>';
            });
            document.getElementById('final-leaderboard').innerHTML = html || '<p style="text-align: center; color: #666;">Sin resultados</p>';
        });
    }

    function backToLobby() {
        document.getElementById('results-screen').classList.remove('active');
        document.getElementById('lobby-screen').classList.add('active');
        updateLobby();
    }

    // =========================
    // HELPERS
    // =========================
    function generateRoomCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let code = '';
        for (let i = 0; i < 6; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
        return code;
    }

    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
</script>
</body>
</html>




