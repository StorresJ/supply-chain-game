<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Chain 4.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); min-height: 100vh; padding: 20px; }
        .container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 900px; width: 100%; margin: 0 auto; padding: 30px; }
        h1 { color: #1e3c72; text-align: center; margin-bottom: 10px; font-size: 2em; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 0.9em; }
        .screen { display: none; }
        .screen.active { display: block; }
        .btn { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 1.1em; cursor: pointer; width: 100%; margin-top: 20px; font-weight: bold; transition: transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn.secondary { background: #6c757d; }
        .input-group { margin: 20px 0; }
        .input-group label { display: block; color: #333; font-weight: bold; margin-bottom: 8px; }
        .input-group input { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1.1em; }
        .input-group input:focus { outline: none; border-color: #1e3c72; }
        .room-code-display { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; text-align: center; margin: 20px 0; font-size: 1.5em; font-weight: bold; letter-spacing: 3px; }
        .team-card { background: #f8f9fa; border: 2px solid #ddd; border-radius: 15px; padding: 20px; margin: 15px 0; cursor: pointer; transition: all 0.3s; }
        .team-card:hover { border-color: #1e3c72; transform: translateY(-3px); }
        .team-card.selected { border-color: #1e3c72; background: #e3f2fd; }
        .team-name { font-size: 1.3em; font-weight: bold; color: #1e3c72; margin-bottom: 10px; }
        .voting-section { background: #f8f9fa; padding: 20px; border-radius: 15px; margin: 20px 0; }
        .vote-option { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border: 2px solid #ddd; border-radius: 10px; margin: 10px 0; cursor: pointer; transition: all 0.3s; }
        .vote-option:hover { border-color: #1e3c72; }
        .vote-option.selected { border-color: #1e3c72; background: #e3f2fd; }
        .vote-count { background: #1e3c72; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; }
        .leaderboard { background: #f8f9fa; padding: 20px; border-radius: 15px; margin: 20px 0; }
        .leaderboard h3 { color: #1e3c72; margin-bottom: 15px; text-align: center; }
        .leaderboard-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ccc; }
        .leaderboard-item.first { border-left-color: #ffd700; background: linear-gradient(90deg, #fffbea 0%, white 100%); }
        .rank { font-size: 1.5em; font-weight: bold; color: #1e3c72; min-width: 40px; }
        .score { font-size: 1.3em; font-weight: bold; color: #4caf50; }
        .info-box { background: #e3f2fd; padding: 15px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #1e3c72; }
        .info-box h4 { color: #1e3c72; margin-bottom: 8px; }
        .player-chip { display: inline-block; background: #e3f2fd; color: #1e3c72; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; margin: 5px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 20px 0; }
        .stat-card { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 12px; border-radius: 10px; text-align: center; }
        .stat-label { font-size: 0.75em; color: #666; margin-bottom: 5px; font-weight: 600; }
        .stat-value { font-size: 1.5em; font-weight: bold; color: #1e3c72; }
        .budget-bar { background: #e0e0e0; height: 30px; border-radius: 15px; margin: 20px 0; overflow: hidden; }
        .budget-fill { background: linear-gradient(90deg, #4caf50 0%, #8bc34a 100%); height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.9em; transition: width 0.3s; }
        .scenario { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #1e3c72; }
        .scenario h3 { color: #333; margin-bottom: 10px; }
        .scenario p { color: #666; line-height: 1.6; margin-bottom: 15px; }
        .options { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .option-btn { background: white; border: 2px solid #1e3c72; color: #333; padding: 15px; border-radius: 10px; cursor: pointer; text-align: left; font-size: 0.95em; transition: all 0.3s; }
        .option-btn:hover:not(:disabled) { background: #e3f2fd; transform: translateX(5px); }
        .option-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .option-cost { display: inline-block; background: #e3f2fd; color: #1976d2; padding: 3px 8px; border-radius: 12px; font-size: 0.85em; font-weight: bold; margin-left: 8px; }
        .feedback { margin-top: 15px; padding: 15px; border-radius: 10px; display: none; }
        .feedback.show { display: block; }
        .feedback.best { background: #e8f5e9; border-left: 4px solid #4caf50; color: #2e7d32; }
        .feedback.good { background: #fff9c4; border-left: 4px solid #fbc02d; color: #f57f17; }
        .feedback.poor { background: #ffebee; border-left: 4px solid #f44336; color: #c62828; }
        .loading { text-align: center; padding: 40px; color: #1e3c72; }
        .timer-container { text-align: center; margin: 20px 0; }
        .timer { display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 40px; border-radius: 15px; font-size: 3em; font-weight: bold; min-width: 150px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4); transition: all 0.3s; }
        .timer.warning { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); animation: pulse 1s infinite; }
        .timer.danger { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); animation: pulse 0.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .timer-label { display: block; font-size: 0.9em; color: #666; margin-bottom: 10px; font-weight: bold; }
        .can-change-vote { background: #fff3e0; padding: 10px; border-radius: 8px; margin-top: 10px; text-align: center; color: #e65100; font-size: 0.9em; }
        @media (max-width: 600px) {
            .container { padding: 20px; }
            h1 { font-size: 1.5em; }
            .grid-2 { grid-template-columns: 1fr; }
            .timer { font-size: 2em; padding: 15px 30px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading-screen" class="loading">
            <h2>Cargando...</h2>
        </div>

        <div id="entry-screen" class="screen">
            <h1>Supply Chain 4.0</h1>
            <p class="subtitle">Modo Multijugador</p>
            <div class="info-box">
                <h4>Como funciona</h4>
                <p>1. Crea sala o unete<br>2. Forma equipo<br>3. Voten dificultad<br>4. Compitan contra el tiempo</p>
            </div>
            <div class="grid-2">
                <button class="btn" onclick="showCreateRoom()">Crear Sala</button>
                <button class="btn secondary" onclick="showJoinRoom()">Unirse</button>
            </div>
            <div id="create-room-form" style="display: none;">
                <div class="input-group">
                    <label>Nombre Sala:</label>
                    <input type="text" id="room-name-input" placeholder="Logistica 101">
                </div>
                <div class="input-group">
                    <label>Tu Nombre:</label>
                    <input type="text" id="host-name-input" placeholder="Tu nombre">
                </div>
                <button class="btn" onclick="createRoom()">Crear</button>
            </div>
            <div id="join-room-form" style="display: none;">
                <div class="input-group">
                    <label>Codigo:</label>
                    <input type="text" id="room-code-input" placeholder="ABC123" style="text-transform: uppercase;" maxlength="6">
                </div>
                <div class="input-group">
                    <label>Tu Nombre:</label>
                    <input type="text" id="player-name-input" placeholder="Tu nombre">
                </div>
                <button class="btn" onclick="joinRoom()">Unirse</button>
            </div>
        </div>

        <div id="lobby-screen" class="screen">
            <h1>Sala: <span id="lobby-room-name">...</span></h1>
            <div class="room-code-display">CODIGO: <span id="room-code-display">...</span></div>
            <div class="info-box">
                <h4>Compartir</h4>
                <p>Comparte el codigo</p>
            </div>
            <div id="pre-team-section">
                <h3 style="color: #1e3c72; margin: 20px 0;">Jugadores:</h3>
                <div id="players-waiting-list"></div>
                <div class="input-group">
                    <label>Nombre Equipo:</label>
                    <input type="text" id="team-name-input" placeholder="Los Logisticos">
                </div>
                <button class="btn" onclick="createTeam()">Crear Equipo</button>
                <div style="margin-top: 30px;">
                    <h3 style="color: #1e3c72;">Equipos:</h3>
                    <div id="teams-list"></div>
                </div>
            </div>
            <div id="team-formed-section" style="display: none;">
                <h3 style="color: #1e3c72; margin: 20px 0;">Tu equipo: <span id="my-team-name"></span></h3>
                <div class="team-card">
                    <div id="my-team-members"></div>
                </div>
                <div class="voting-section">
                    <h3 style="color: #1e3c72; margin-bottom: 15px;">Vota Dificultad</h3>
                    <p style="color: #666; margin-bottom: 10px;">Puedes cambiar tu voto</p>
                    <div class="vote-option" onclick="vote('easy')">
                        <div>
                            <strong>Principiante</strong><br>
                            <span style="font-size: 0.9em; color: #666;">$800K | 30s por decision</span>
                        </div>
                        <div class="vote-count" id="votes-easy">0</div>
                    </div>
                    <div class="vote-option" onclick="vote('normal')">
                        <div>
                            <strong>Normal</strong><br>
                            <span style="font-size: 0.9em; color: #666;">$600K | 25s por decision</span>
                        </div>
                        <div class="vote-count" id="votes-normal">0</div>
                    </div>
                    <div class="vote-option" onclick="vote('hard')">
                        <div>
                            <strong>Experto</strong><br>
                            <span style="font-size: 0.9em; color: #666;">$400K | 20s por decision</span>
                        </div>
                        <div class="vote-count" id="votes-hard">0</div>
                    </div>
                    <div class="can-change-vote" id="my-vote-display" style="display: none;">
                        Tu voto: <strong id="my-vote-text"></strong>
                    </div>
                </div>
                <div class="info-box" id="waiting-message">
                    <h4>Esperando...</h4>
                </div>
                <button class="btn" id="start-game-btn" onclick="startMultiplayerGame()" style="display: none;">Comenzar</button>
            </div>
            <div class="leaderboard">
                <h3>Equipos</h3>
                <div id="all-teams-list"></div>
            </div>
        </div>

        <div id="game-screen" class="screen">
            <h1>Supply Chain 4.0</h1>
            <p class="subtitle">Equipo: <span id="playing-team-name"></span></p>
            <div class="timer-container">
                <span class="timer-label">TIEMPO RESTANTE</span>
                <div id="timer" class="timer">--</div>
            </div>
            <div class="budget-bar">
                <div id="budget-fill" class="budget-fill">$<span id="budget-text">600</span>K</div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Eficiencia</div>
                    <div id="efficiency" class="stat-value">65%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Costos</div>
                    <div id="costs" class="stat-value">$450K</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Satisfaccion</div>
                    <div id="satisfaction" class="stat-value">72%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Sostenibilidad</div>
                    <div id="sustainability" class="stat-value">60%</div>
                </div>
            </div>
            <div id="scenario-container"></div>
        </div>

        <div id="results-screen" class="screen">
            <h1>Resultados</h1>
            <div class="info-box">
                <h4>Equipo: <span id="results-team-name"></span></h4>
                <p style="font-size: 1.3em; color: #1e3c72; font-weight: bold; margin-top: 10px;">
                    Puntos: <span id="results-team-score"></span>
                </p>
                <p style="margin-top: 10px; color: #666;">
                    Bonus tiempo: <strong style="color: #4caf50;">+<span id="time-bonus">0</span> pts</strong>
                </p>
            </div>
            <div class="leaderboard">
                <h3>Clasificacion</h3>
                <div id="final-leaderboard"></div>
            </div>
            <button class="btn" onclick="backToLobby()">Volver</button>
            <button class="btn secondary" onclick="location.reload()">Nueva Sala</button>
        </div>
    </div>

    <!-- Firebase + Lógica del juego -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        let db, currentRoom, currentPlayer, currentTeam, roomListener;
        let timerInterval = null, timeRemaining = 0, timeLimit = 0, totalTimeBonus = 0;
        let currentScenarios = []; // Escenarios según dificultad

        // =========================
        // ESCENARIOS POR DIFICULTAD
        // =========================
        const scenariosByDifficulty = {
            easy: [
                {
                    title: "Retraso en proveedor local",
                    company: "Pyme Textil",
                    description: "Tu principal proveedor local de tela avisa un retraso de 5 días. Tienes inventario limitado en tiendas y temporada alta de ventas se acerca.",
                    options: [
                        {
                            text: "Redistribuir inventario entre tiendas según ventas históricas",
                            cost: 40,
                            impacts: { efficiency: 10, costs: -15, satisfaction: 8, sustainability: 3 },
                            quality: "best",
                            feedback: "Buena práctica: balanceas inventario usando datos básicos sin disparar costos.",
                            points: 20
                        },
                        {
                            text: "Ordenar producción extra al mismo proveedor pagando hora extra",
                            cost: 80,
                            impacts: { efficiency: 5, costs: 30, satisfaction: 5, sustainability: -2 },
                            quality: "good",
                            feedback: "Funciona, pero incrementa bastante tus costos.",
                            points: 12
                        },
                        {
                            text: "No hacer nada y esperar a que el proveedor se recupere solo",
                            cost: 0,
                            impacts: { efficiency: -10, costs: 0, satisfaction: -12, sustainability: 0 },
                            quality: "poor",
                            feedback: "Pierdes ventas y generas insatisfacción por quiebres de stock.",
                            points: 5
                        },
                        {
                            text: "Buscar un proveedor alterno de emergencia sin revisar calidad",
                            cost: 35,
                            impacts: { efficiency: -2, costs: -5, satisfaction: -8, sustainability: -3 },
                            quality: "poor",
                            feedback: "Respuesta trampa: suena ágil, pero la mala calidad puede afectar tu marca.",
                            points: 6
                        }
                    ]
                },
                {
                    title: "Visibilidad básica de inventarios",
                    company: "Retail Regional",
                    description: "Tienes tiendas en tres ciudades. Cada tienda maneja su inventario en Excel y hay diferencias entre lo que reportan y lo que realmente tienen.",
                    options: [
                        {
                            text: "Centralizar el inventario en un sistema en la nube con actualización diaria",
                            cost: 60,
                            impacts: { efficiency: 12, costs: -20, satisfaction: 10, sustainability: 5 },
                            quality: "best",
                            feedback: "Unificas la información y reduces errores, un paso clave hacia Supply Chain 4.0.",
                            points: 22
                        },
                        {
                            text: "Pedir inventarios físicos semanales sin cambiar el sistema",
                            cost: 25,
                            impacts: { efficiency: -3, costs: 5, satisfaction: 2, sustainability: -2 },
                            quality: "good",
                            feedback: "Mejora un poco el control, pero sigues con procesos manuales y lentos.",
                            points: 10
                        },
                        {
                            text: "Confiar en el inventario que diga la tienda principal",
                            cost: 5,
                            impacts: { efficiency: -8, costs: 0, satisfaction: -10, sustainability: 0 },
                            quality: "poor",
                            feedback: "Decisión centralizada sin datos confiables aumenta errores y quiebres.",
                            points: 4
                        },
                        {
                            text: "Implementar sensores IoT en todas las tiendas sin capacitación",
                            cost: 90,
                            impacts: { efficiency: 2, costs: 40, satisfaction: -2, sustainability: 4 },
                            quality: "poor",
                            feedback: "Respuesta trampa: mucha tecnología, pero sin cambio de procesos ni entrenamiento.",
                            points: 7
                        }
                    ]
                },
                {
                    title: "Transporte de última milla",
                    company: "E-commerce Local",
                    description: "Tus pedidos en la ciudad llegan en 48–72 horas. Tus clientes empiezan a comparar con la competencia que ofrece entregas en 24 horas.",
                    options: [
                        {
                            text: "Diseñar rutas básicas con zonas por código postal y entregas programadas",
                            cost: 50,
                            impacts: { efficiency: 10, costs: -10, satisfaction: 12, sustainability: 4 },
                            quality: "best",
                            feedback: "Organizas mejor la operación con un esfuerzo razonable.",
                            points: 20
                        },
                        {
                            text: "Ofrecer entregas ultrarrápidas en moto a todos los clientes sin recargo",
                            cost: 95,
                            impacts: { efficiency: 10, costs: 40, satisfaction: 15, sustainability: -10 },
                            quality: "good",
                            feedback: "Mejoras experiencia, pero sacrificas mucho margen y sostenibilidad.",
                            points: 14
                        },
                        {
                            text: "Mantener tiempos actuales y lanzar una campaña diciendo que la espera vale la pena",
                            cost: 10,
                            impacts: { efficiency: 0, costs: 0, satisfaction: -8, sustainability: 0 },
                            quality: "poor",
                            feedback: "La comunicación no compensa la diferencia de servicio frente a la competencia.",
                            points: 5
                        },
                        {
                            text: "Tercerizar la última milla con un operador sin revisar sus indicadores",
                            cost: 45,
                            impacts: { efficiency: -5, costs: -5, satisfaction: -10, sustainability: -3 },
                            quality: "poor",
                            feedback: "Respuesta trampa: parece eficiente, pero sin KPIs puedes empeorar el servicio.",
                            points: 6
                        }
                    ]
                }
            ],
            normal: [
                {
                    title: "Crisis Suez (Versión Intermedia)",
                    company: "2021 – Multinacional de Electrónicos",
                    description: "Un bloqueo en una vía marítima clave retrasa tus contenedores. Tienes demanda firme en Europa y acuerdos de servicio exigentes.",
                    options: [
                        {
                            text: "Reoptimizar rutas usando analítica + datos históricos y priorizar productos críticos",
                            cost: 80,
                            impacts: { efficiency: 18, costs: -35, satisfaction: 14, sustainability: -4 },
                            quality: "best",
                            feedback: "Enfoque Supply Chain 4.0: datos + priorización por criticidad.",
                            points: 26
                        },
                        {
                            text: "Enviar por transporte aéreo únicamente los productos de más alta rotación",
                            cost: 120,
                            impacts: { efficiency: 8, costs: 50, satisfaction: 12, sustainability: -18 },
                            quality: "good",
                            feedback: "Usas bien el aire, pero el costo y la huella de carbono son altos.",
                            points: 18
                        },
                        {
                            text: "Cambiar todo el volumen a transporte aéreo para cumplir con todos los clientes",
                            cost: 190,
                            impacts: { efficiency: 15, costs: 90, satisfaction: 16, sustainability: -25 },
                            quality: "poor",
                            feedback: "Respuesta trampa: cubres la demanda, pero el costo y sostenibilidad explotan.",
                            points: 8
                        },
                        {
                            text: "Esperar a que se normalice el canal sin ajustar planes ni comunicar",
                            cost: 5,
                            impacts: { efficiency: -12, costs: 0, satisfaction: -15, sustainability: 2 },
                            quality: "poor",
                            feedback: "Sin comunicación ni plan alterno, el impacto en servicio es grave.",
                            points: 4
                        }
                    ]
                },
                {
                    title: "IA Predictiva para Inventarios",
                    company: "Amazon (Caso Adaptado)",
                    description: "Tu empresa quiere pasar de pronósticos por promedio histórico a un modelo más avanzado. Tienes datos de demanda, promociones y clima.",
                    options: [
                        {
                            text: "Implementar un modelo de IA que incorpore promociones, clima y tendencias",
                            cost: 100,
                            impacts: { efficiency: 22, costs: -55, satisfaction: 18, sustainability: 10 },
                            quality: "best",
                            feedback: "Conectas múltiples fuentes de datos y mejoras precisión de pronósticos.",
                            points: 28
                        },
                        {
                            text: "Seguír usando solo el año pasado, ajustando manualmente según intuición",
                            cost: 10,
                            impacts: { efficiency: -4, costs: 10, satisfaction: -8, sustainability: -6 },
                            quality: "poor",
                            feedback: "Método simple que no captura cambios de mercado actuales.",
                            points: 6
                        },
                        {
                            text: "Comprar un software caro de IA sin integrar tus datos operativos",
                            cost: 120,
                            impacts: { efficiency: 2, costs: 40, satisfaction: 0, sustainability: 0 },
                            quality: "poor",
                            feedback: "Respuesta trampa: tecnología sin datos ni integración no agrega valor.",
                            points: 7
                        },
                        {
                            text: "Hacer un piloto en una categoría clave y escalar según resultados",
                            cost: 60,
                            impacts: { efficiency: 15, costs: -20, satisfaction: 10, sustainability: 5 },
                            quality: "good",
                            feedback: "Camino razonable: aprendes en pequeño antes de escalar.",
                            points: 20
                        }
                    ]
                },
                {
                    title: "Blockchain en Trazabilidad",
                    company: "Walmart (Caso Adaptado)",
                    description: "Quieren garantizar origen ético de alimentos frescos y responder rápido ante posibles retiros de producto.",
                    options: [
                        {
                            text: "Implementar trazabilidad con blockchain desde productor hasta tienda, con escaneo en tiempo real",
                            cost: 95,
                            impacts: { efficiency: 14, costs: -25, satisfaction: 20, sustainability: 16 },
                            quality: "best",
                            feedback: "Transparencia, confianza y rapidez en respuesta ante incidentes.",
                            points: 26
                        },
                        {
                            text: "Mantener PDFs y certificados en correos de proveedores",
                            cost: 15,
                            impacts: { efficiency: -6, costs: 5, satisfaction: -10, sustainability: -4 },
                            quality: "poor",
                            feedback: "Información dispersa y poco confiable.",
                            points: 5
                        },
                        {
                            text: "Usar hojas de cálculo compartidas sin roles ni control de cambios",
                            cost: 20,
                            impacts: { efficiency: -2, costs: 0, satisfaction: -6, sustainability: -2 },
                            quality: "poor",
                            feedback: "Respuesta trampa: parece colaborativo, pero no tienes trazabilidad robusta.",
                            points: 7
                        },
                        {
                            text: "Exigir auditorías externas periódicas sin mejorar tus sistemas internos",
                            cost: 55,
                            impacts: { efficiency: 0, costs: 15, satisfaction: 5, sustainability: 4 },
                            quality: "good",
                            feedback: "Mejora en control, pero sigues sin datos en tiempo real.",
                            points: 16
                        }
                    ]
                }
            ],
            hard: [
                {
                    title: "Rediseño de Red post-Crisis Global",
                    company: "Multinacional Farmacéutica",
                    description: "Tras una pandemia, tu red está sobredimensionada en algunos países y frágil en otros. Debes rediseñarla usando enfoques 4.0.",
                    options: [
                        {
                            text: "Diseñar una red multimodal apoyada en gemelos digitales y simulación de escenarios",
                            cost: 110,
                            impacts: { efficiency: 22, costs: -45, satisfaction: 18, sustainability: 12 },
                            quality: "best",
                            feedback: "Usas gemelos digitales para balancear costo, servicio y riesgo.",
                            points: 34
                        },
                        {
                            text: "Cerrar centros de distribución solo donde el costo operativo es más alto",
                            cost: 55,
                            impacts: { efficiency: -4, costs: -20, satisfaction: -6, sustainability: 0 },
                            quality: "poor",
                            feedback: "Respuesta trampa: miras solo costo, ignoras resiliencia y servicio.",
                            points: 10
                        },
                        {
                            text: "Mantener la red actual y solo aumentar inventarios de seguridad",
                            cost: 80,
                            impacts: { efficiency: -6, costs: 35, satisfaction: 6, sustainability: -8 },
                            quality: "poor",
                            feedback: "Más inventario no soluciona la fragilidad estructural de la red.",
                            points: 8
                        },
                        {
                            text: "Centralizar todas las decisiones en la casa matriz sin analítica local",
                            cost: 30,
                            impacts: { efficiency: -10, costs: 5, satisfaction: -12, sustainability: -4 },
                            quality: "poor",
                            feedback: "Reduces autonomía local y empeoras la respuesta ante disrupciones.",
                            points: 6
                        }
                    ]
                },
                {
                    title: "Orquestación de Datos en Tiempo Real",
                    company: "Operador Logístico Global",
                    description: "Tu empresa maneja miles de envíos diarios. Tienes sistemas heredados, sensores IoT, datos de clima y tráfico, pero están desconectados.",
                    options: [
                        {
                            text: "Construir una plataforma de datos unificada (data lake) y dashboards de control en tiempo real",
                            cost: 120,
                            impacts: { efficiency: 24, costs: -40, satisfaction: 20, sustainability: 10 },
                            quality: "best",
                            feedback: "Integras fuentes de datos y habilitas decisiones en tiempo real.",
                            points: 36
                        },
                        {
                            text: "Agregar más sensores IoT sin integrar con los sistemas existentes",
                            cost: 70,
                            impacts: { efficiency: 2, costs: 20, satisfaction: 0, sustainability: 3 },
                            quality: "poor",
                            feedback: "Respuesta trampa: más datos sin integración solo incrementan complejidad.",
                            points: 9
                        },
                        {
                            text: "Contratar analistas para revisar reportes diarios en Excel",
                            cost: 45,
                            impacts: { efficiency: -2, costs: 10, satisfaction: 4, sustainability: 0 },
                            quality: "good",
                            feedback: "Mejora algo el análisis, pero sigues reaccionando tarde.",
                            points: 16
                        },
                        {
                            text: "Usar únicamente la experiencia de los planificadores senior",
                            cost: 15,
                            impacts: { efficiency: -8, costs: 0, satisfaction: -6, sustainability: 0 },
                            quality: "poor",
                            feedback: "Depender solo de intuición no escala ni es replicable.",
                            points: 7
                        }
                    ]
                },
                {
                    title: "Sostenibilidad vs Servicio en Cadena Global",
                    company: "Marca de Moda Internacional",
                    description: "La compañía quiere reducir su huella de carbono manteniendo tiempos de entrega competitivos en varios continentes.",
                    options: [
                        {
                            text: "Optimizar la red usando analítica para combinar hubs regionales, transporte marítimo y aéreo solo para urgencias",
                            cost: 105,
                            impacts: { efficiency: 20, costs: -30, satisfaction: 16, sustainability: 22 },
                            quality: "best",
                            feedback: "Equilibras servicio, costo y sostenibilidad con decisiones basadas en datos.",
                            points: 35
                        },
                        {
                            text: "Cambiar todo el transporte a marítimo para reducir CO₂",
                            cost: 70,
                            impacts: { efficiency: -12, costs: -20, satisfaction: -18, sustainability: 25 },
                            quality: "poor",
                            feedback: "Respuesta trampa: mejora ambiental, pero destruye tu nivel de servicio.",
                            points: 9
                        },
                        {
                            text: "Compensar huella de carbono plantando árboles sin cambiar la red",
                            cost: 50,
                            impacts: { efficiency: 0, costs: 10, satisfaction: 4, sustainability: 8 },
                            quality: "good",
                            feedback: "Ayuda, pero no resuelve la causa raíz en la cadena de suministro.",
                            points: 18
                        },
                        {
                            text: "Subir precios para cubrir cualquier solución verde sin comunicar el valor",
                            cost: 30,
                            impacts: { efficiency: 0, costs: 0, satisfaction: -10, sustainability: 5 },
                            quality: "poor",
                            feedback: "El cliente no entiende el porqué del aumento y puede abandonar tu marca.",
                            points: 6
                        }
                    ]
                }
            ]
        };

        // Caso final común
        const finalCase = {
            title: "Caso Final: Expansión a Sudamérica",
            description: "Tu empresa opera con un sistema relativamente estable en Norteamérica. Ahora quiere expandirse a Sudamérica, donde la infraestructura es limitada, la demanda es volátil y los clientes son muy sensibles a tiempos de entrega.",
            question: "¿Cuál estrategia refleja mejor una Supply Chain 4.0 adaptada al nuevo contexto?",
            options: [
                {
                    text: "Replicar el sistema actual y usar los mismos distribuidores tradicionales",
                    points: 25,
                    feedback: "Conservador: puedes operar, pero no aprovechas la flexibilidad ni la analítica avanzada.",
                    isCorrect: false
                },
                {
                    text: "Usar nube + IoT para visibilidad, alianzas locales, IA para rutas y analítica de demanda",
                    points: 50,
                    feedback: "Excelente: diseñas una red adaptativa, conectada y basada en datos.",
                    isCorrect: true
                },
                {
                    text: "Crear mega-almacenes propios y mover el 60% por transporte aéreo",
                    points: 15,
                    feedback: "Muy costoso e insostenible a largo plazo, aunque rápido.",
                    isCorrect: false
                },
                {
                    text: "Ir solo con e-commerce sin presencia física ni socios locales",
                    points: 20,
                    feedback: "Tu cobertura es limitada y los tiempos de entrega son poco competitivos en muchas zonas.",
                    isCorrect: false
                }
            ]
        };

        let gameState = {
            currentScenario: 0,
            efficiency: 65,
            costs: 450,
            satisfaction: 72,
            sustainability: 60,
            budget: 600,
            maxBudget: 600,
            score: 0
        };

        function resetGameState() {
            gameState = {
                currentScenario: 0,
                efficiency: 65,
                costs: 450,
                satisfaction: 72,
                sustainability: 60,
                budget: 600,
                maxBudget: 600,
                score: 0
            };
        }

        // INIT FIREBASE
        function initApp() {
            try {
                if (typeof firebase === 'undefined') {
                    document.getElementById('loading-screen').innerHTML = '<h2 style="color: red;">Error Firebase</h2>';
                    return;
                }
                firebase.initializeApp({
                    apiKey: "AIzaSyDIUt20W8U7cUDqyfLYxqrs2-pNwTodvi4",
                    authDomain: "supply-chain-game-f1bc4.firebaseapp.com",
                    databaseURL: "https://supply-chain-game-f1bc4-default-rtdb.firebaseio.com",
                    projectId: "supply-chain-game-f1bc4",
                    storageBucket: "supply-chain-game-f1bc4.firebasestorage.app",
                    messagingSenderId: "992566402291",
                    appId: "1:992566402291:web:3a699f86b04cca816eab86"
                });
                db = firebase.database();
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('entry-screen').classList.add('active');
            } catch (e) {
                document.getElementById('loading-screen').innerHTML = '<h2 style="color: red;">Error: ' + e.message + '</h2>';
            }
        }

        window.addEventListener('load', () => setTimeout(initApp, 500));

        // ENTRADA / SALA
        function showCreateRoom() {
            document.getElementById('create-room-form').style.display = 'block';
            document.getElementById('join-room-form').style.display = 'none';
        }
        function showJoinRoom() {
            document.getElementById('join-room-form').style.display = 'block';
            document.getElementById('create-room-form').style.display = 'none';
        }

        function createRoom() {
            const roomName = document.getElementById('room-name-input').value.trim();
            const hostName = document.getElementById('host-name-input').value.trim();
            if (!roomName || !hostName) {
                alert('Completa campos');
                return;
            }
            const roomCode = generateRoomCode();
            currentPlayer = { name: hostName, id: generateId() };
            currentRoom = {
                code: roomCode,
                name: roomName,
                host: currentPlayer.id,
                players: {},
                teams: {},
                votes: {},
                difficulty: null,
                status: 'lobby',
                createdAt: Date.now()
            };
            currentRoom.players[currentPlayer.id] = currentPlayer;
            db.ref('rooms/' + roomCode).set(currentRoom)
                .then(() => {
                    listenToRoom(roomCode);
                    showLobby();
                })
                .catch(err => alert('Error: ' + err.message));
        }

        function joinRoom() {
            const roomCode = document.getElementById('room-code-input').value.trim().toUpperCase();
            const playerName = document.getElementById('player-name-input').value.trim();
            if (!roomCode || !playerName) {
                alert('Completa campos');
                return;
            }
            currentPlayer = { name: playerName, id: generateId() };
            db.ref('rooms/' + roomCode).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    currentRoom = snapshot.val();
                    db.ref('rooms/' + roomCode + '/players/' + currentPlayer.id).set(currentPlayer)
                        .then(() => {
                            listenToRoom(roomCode);
                            showLobby();
                        });
                } else alert('Codigo no existe');
            }).catch(err => alert('Error: ' + err.message));
        }

        function createTeam() {
            const teamName = document.getElementById('team-name-input').value.trim();
            if (!teamName) {
                alert('Nombre equipo');
                return;
            }
            const teamId = generateId();
            currentTeam = {
                id: teamId,
                name: teamName,
                members: [currentPlayer.id],
                status: 'waiting',
                score: 0,
                timeBonus: 0,
                createdAt: Date.now()
            };
            db.ref('rooms/' + currentRoom.code + '/teams/' + teamId).set(currentTeam).then(() => {
                document.getElementById('pre-team-section').style.display = 'none';
                document.getElementById('team-formed-section').style.display = 'block';
            });
        }

        function joinTeam(teamId) {
            const team = currentRoom.teams[teamId];
            if (team && !team.members.includes(currentPlayer.id)) {
                team.members.push(currentPlayer.id);
                currentTeam = team;
                db.ref('rooms/' + currentRoom.code + '/teams/' + teamId + '/members').set(team.members).then(() => {
                    document.getElementById('pre-team-section').style.display = 'none';
                    document.getElementById('team-formed-section').style.display = 'block';
                });
            }
        }

        function vote(difficulty) {
            if (!currentTeam) return;
            db.ref('rooms/' + currentRoom.code + '/votes/' + currentTeam.id).set(difficulty);
            updateMyVoteDisplay(difficulty);
        }

        function updateMyVoteDisplay(difficulty) {
            const displayDiv = document.getElementById('my-vote-display');
            const textSpan = document.getElementById('my-vote-text');
            const labels = { easy: 'Principiante', normal: 'Normal', hard: 'Experto' };
            textSpan.textContent = labels[difficulty];
            displayDiv.style.display = 'block';
        }

        function startMultiplayerGame() {
            const difficulties = {
                easy: { budget: 800, time: 30 },
                normal: { budget: 600, time: 25 },
                hard: { budget: 400, time: 20 }
            };

            const config = difficulties[currentRoom.difficulty] || difficulties.normal;

            // Escenarios según dificultad
            currentScenarios = scenariosByDifficulty[currentRoom.difficulty] || scenariosByDifficulty.normal;

            resetGameState();
            gameState.budget = config.budget;
            gameState.maxBudget = config.budget;
            timeLimit = config.time;
            totalTimeBonus = 0;

            db.ref('rooms/' + currentRoom.code + '/teams/' + currentTeam.id + '/status').set('playing');
            showGame();
        }

        // TIMER
        function startTimer() {
            timeRemaining = timeLimit;
            updateTimerDisplay();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerDisplay() {
            const timerEl = document.getElementById('timer');
            timerEl.textContent = timeRemaining + 's';
            timerEl.className = 'timer';
            if (timeRemaining <= 5) timerEl.classList.add('danger');
            else if (timeRemaining <= 10) timerEl.classList.add('warning');
        }

        function handleTimeout() {
            document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
            const feedbackDiv = document.getElementById('feedback');
            feedbackDiv.className = 'feedback show poor';
            feedbackDiv.innerHTML = '<strong>Tiempo agotado!</strong><p>0 puntos</p>';
            setTimeout(() => feedbackDiv.innerHTML += '<button class="btn" onclick="nextScenario()">Continuar</button>', 2000);
        }

        // ESCENARIOS
        function selectOption(scenarioIndex, optionIndex) {
            const scenario = currentScenarios[scenarioIndex];
            const option = scenario.options[optionIndex];
            if (option.cost > gameState.budget) return;

            stopTimer();
            const timeBonus = Math.max(0, timeRemaining);
            totalTimeBonus += timeBonus;

            document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
            gameState.budget -= option.cost;
            Object.keys(option.impacts).forEach(key => gameState[key] += option.impacts[key]);
            gameState.score += option.points + timeBonus;
            updateStats();

            const feedbackDiv = document.getElementById('feedback');
            feedbackDiv.className = 'feedback show ' + option.quality;
            feedbackDiv.innerHTML =
                '<strong>' +
                (option.quality === 'best' ? 'Excelente!' : option.quality === 'good' ? 'Buena' : 'Subóptima') +
                '</strong><p>' + option.feedback + '</p>' +
                '<p><strong>Puntos:</strong> +' + option.points + '</p>' +
                '<p style="color: #4caf50;"><strong>Bonus tiempo:</strong> +' + timeBonus + '</p>';

            setTimeout(() => {
                feedbackDiv.innerHTML += '<button class="btn" onclick="nextScenario()">' +
                    (scenarioIndex < currentScenarios.length - 1 ? 'Siguiente' : 'Caso Final') +
                    '</button>';
            }, 1500);
        }

        function nextScenario() {
            if (gameState.currentScenario < currentScenarios.length - 1) {
                loadScenario(gameState.currentScenario + 1);
            } else {
                loadFinalCase();
            }
        }

        function loadFinalCase() {
            gameState.currentScenario++;
            let html =
                '<div class="scenario">' +
                '<h3>' + finalCase.title + '</h3>' +
                '<div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 3px solid #ff9800;">' +
                '<strong>CONTEXTO:</strong>' +
                '<p style="margin-top: 10px;">' + finalCase.description + '</p>' +
                '</div>' +
                '<p style="font-weight: bold; font-size: 1.1em; margin-top: 15px;">' + finalCase.question + '</p>' +
                '<div class="info-box" style="background: #fff3e0; border-left-color: #ff9800;">' +
                '<p style="color: #e65100; font-weight: bold;">SIN TIEMPO - Analiza bien</p>' +
                '</div>' +
                '<div class="options">';

            finalCase.options.forEach((option, i) => {
                html += '<button class="option-btn" onclick="selectFinalOption(' + i + ')" style="padding: 20px;">' +
                    option.text + '</button>';
            });

            html += '</div><div id="feedback" class="feedback"></div></div>';
            document.getElementById('scenario-container').innerHTML = html;

            stopTimer();
            document.getElementById('timer').textContent = 'infinito';
            document.getElementById('timer').className = 'timer';
        }

        function selectFinalOption(optionIndex) {
            const option = finalCase.options[optionIndex];
            stopTimer();

            document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
            gameState.score += option.points;
            updateStats();

            const feedbackDiv = document.getElementById('feedback');
            feedbackDiv.className = 'feedback show ' + (option.isCorrect ? 'best' : 'poor');
            feedbackDiv.innerHTML =
                '<strong>' + (option.isCorrect ? 'CORRECTO!' : 'No óptima') + '</strong>' +
                '<p>' + option.feedback + '</p>' +
                '<p><strong>Puntos:</strong> +' + option.points + '</p>';

            setTimeout(() => feedbackDiv.innerHTML += '<button class="btn" onclick="endGame()">Ver Resultados</button>', 2000);
        }

        // LOBBY / LISTENERS
        function backToLobby() {
            document.getElementById('results-screen').classList.remove('active');
            document.getElementById('lobby-screen').classList.add('active');
            updateLobby();
        }

        function listenToRoom(roomCode) {
            roomListener = db.ref('rooms/' + roomCode).on('value', snapshot => {
                if (snapshot.exists()) {
                    currentRoom = snapshot.val();
                    updateLobby();
                    checkIfAllVoted();
                }
            });
        }

        function checkIfAllVoted() {
            if (!currentRoom || !currentRoom.teams) return;
            const allTeams = Object.values(currentRoom.teams);
            if (allTeams.length === 0) return;
            const allVoted = allTeams.every(team => currentRoom.votes && currentRoom.votes[team.id]);
            if (allVoted && !currentRoom.difficulty) {
                const voteCounts = { easy: 0, normal: 0, hard: 0 };
                Object.values(currentRoom.votes).forEach(vote => voteCounts[vote]++);
                let winningDifficulty = 'normal', maxVotes = 0;
                Object.entries(voteCounts).forEach(([diff, count]) => {
                    if (count > maxVotes) {
                        maxVotes = count;
                        winningDifficulty = diff;
                    }
                });
                db.ref('rooms/' + currentRoom.code + '/difficulty').set(winningDifficulty);
            }
            if (currentRoom.difficulty && currentTeam) {
                document.getElementById('waiting-message').style.display = 'none';
                document.getElementById('start-game-btn').style.display = 'block';
            }
        }

        function showLobby() {
            document.getElementById('entry-screen').classList.remove('active');
            document.getElementById('lobby-screen').classList.add('active');
            document.getElementById('lobby-room-name').textContent = currentRoom.name;
            document.getElementById('room-code-display').textContent = currentRoom.code;
            updateLobby();
        }

        function updateLobby() {
            if (!currentRoom) return;
            const playersWithoutTeam = Object.values(currentRoom.players || {}).filter(player =>
                !Object.values(currentRoom.teams || {}).some(team => team.members && team.members.includes(player.id))
            );
            let playersHTML = '';
            playersWithoutTeam.forEach(player => playersHTML += '<span class="player-chip">' + player.name + '</span>');
            document.getElementById('players-waiting-list').innerHTML = playersHTML || '<p style="color: #666;">Todos en equipos</p>';

            let teamsHTML = '';
            Object.values(currentRoom.teams || {}).forEach(team => {
                const isMyTeam = currentTeam && currentTeam.id === team.id;
                const canJoin = !isMyTeam && currentPlayer && !team.members.includes(currentPlayer.id);
                teamsHTML +=
                    '<div class="team-card ' + (isMyTeam ? 'selected' : '') + '" ' +
                    (canJoin ? 'onclick="joinTeam(\'' + team.id + '\')"' : '') + '>' +
                    '<div class="team-name">' + team.name + (isMyTeam ? ' (Tu equipo)' : '') + '</div>' +
                    '<div style="color: #666;">' + team.members.length + ' miembro(s)</div></div>';
            });
            document.getElementById('teams-list').innerHTML = teamsHTML || '<p style="color: #666;">No hay equipos</p>';

            if (currentTeam && currentRoom.teams && currentRoom.teams[currentTeam.id]) {
                const updatedTeam = currentRoom.teams[currentTeam.id];
                document.getElementById('my-team-name').textContent = updatedTeam.name;
                let membersHTML = '';
                updatedTeam.members.forEach(memberId => {
                    const member = currentRoom.players[memberId];
                    if (member) membersHTML += '<span class="player-chip">' + member.name + '</span>';
                });
                document.getElementById('my-team-members').innerHTML = membersHTML;
            }

            let allTeamsHTML = '';
            Object.values(currentRoom.teams || {}).forEach(team => {
                allTeamsHTML +=
                    '<div class="leaderboard-item">' +
                    '<div class="rank">' + team.members.length + '</div>' +
                    '<div style="flex: 1; margin: 0 15px;"><strong>' + team.name + '</strong></div>' +
                    (team.score > 0 ? '<div class="score">' + team.score + '</div>' : '<div style="color: #999;">---</div>') +
                    '</div>';
            });
            document.getElementById('all-teams-list').innerHTML = allTeamsHTML || '<p style="text-align: center; color: #666;">Sin equipos</p>';

            if (!currentRoom || !currentRoom.votes) return;
            const voteCounts = { easy: 0, normal: 0, hard: 0 };
            Object.values(currentRoom.votes).forEach(vote => voteCounts[vote]++);
            document.getElementById('votes-easy').textContent = voteCounts.easy;
            document.getElementById('votes-normal').textContent = voteCounts.normal;
            document.getElementById('votes-hard').textContent = voteCounts.hard;

            if (currentTeam && currentRoom.votes && currentRoom.votes[currentTeam.id]) {
                updateMyVoteDisplay(currentRoom.votes[currentTeam.id]);
            }
        }

        // GAME SCREEN
        function showGame() {
            document.getElementById('lobby-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            document.getElementById('playing-team-name').textContent = currentTeam.name;
            updateStats();
            loadScenario(0);
        }

        function loadScenario(index) {
            if (index >= currentScenarios.length) {
                loadFinalCase();
                return;
            }
            gameState.currentScenario = index;
            const scenario = currentScenarios[index];
            let html =
                '<div class="scenario">' +
                '<h3>' + scenario.title + '</h3>' +
                '<p style="color: #666;">' + scenario.company + '</p>' +
                '<p>' + scenario.description + '</p>' +
                '<div class="options">';

            scenario.options.forEach((option, i) => {
                const disabled = option.cost > gameState.budget ? 'disabled' : '';
                html +=
                    '<button class="option-btn" onclick="selectOption(' + index + ', ' + i + ')" ' + disabled + '>' +
                    option.text +
                    '<span class="option-cost">$' + option.cost + 'K</span></button>';
            });

            html += '</div><div id="feedback" class="feedback"></div></div>';
            document.getElementById('scenario-container').innerHTML = html;
            startTimer();
        }

        function updateStats() {
            gameState.efficiency = Math.max(0, Math.min(100, gameState.efficiency));
            gameState.satisfaction = Math.max(0, Math.min(100, gameState.satisfaction));
            gameState.sustainability = Math.max(0, Math.min(100, gameState.sustainability));
            document.getElementById('efficiency').textContent = Math.round(gameState.efficiency) + '%';
            document.getElementById('costs').textContent = '$' + gameState.costs + 'K';
            document.getElementById('satisfaction').textContent = Math.round(gameState.satisfaction) + '%';
            document.getElementById('sustainability').textContent = Math.round(gameState.sustainability) + '%';
            document.getElementById('budget-text').textContent = gameState.budget;
            document.getElementById('budget-fill').style.width = ((gameState.budget / gameState.maxBudget) * 100) + '%';
        }

        // RESULTADOS
        function endGame() {
            stopTimer();
            const avgMetrics = (gameState.efficiency + gameState.satisfaction + gameState.sustainability) / 3;
            const finalScore = Math.round(gameState.score + avgMetrics);
            db.ref('rooms/' + currentRoom.code + '/teams/' + currentTeam.id).update({
                score: finalScore,
                timeBonus: totalTimeBonus,
                status: 'finished'
            }).then(() => showResults());
        }

        function showResults() {
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('results-screen').classList.add('active');
            document.getElementById('results-team-name').textContent = currentTeam.name;
            document.getElementById('time-bonus').textContent = totalTimeBonus;

            db.ref('rooms/' + currentRoom.code + '/teams/' + currentTeam.id + '/score').once('value').then(snapshot => {
                document.getElementById('results-team-score').textContent = (snapshot.val() || 0) + ' pts';
            });

            db.ref('rooms/' + currentRoom.code + '/teams').once('value').then(snapshot => {
                const teams = snapshot.val() || {};
                const sortedTeams = Object.values(teams)
                    .filter(team => team.status === 'finished')
                    .sort((a, b) => (b.score || 0) - (a.score || 0));

                let html = '';
                sortedTeams.forEach((team, index) => {
                    const rankClass = index === 0 ? 'first' : '';
                    const medal = ['🥇', '🥈', '🥉'][index] || (index + 1);
                    html +=
                        '<div class="leaderboard-item ' + rankClass + '">' +
                        '<div class="rank">' + medal + '</div>' +
                        '<div style="flex: 1; margin: 0 15px;"><strong>' + team.name +
                        '</strong><br><small style="color: #666;">Bonus: +' + (team.timeBonus || 0) + ' pts</small></div>' +
                        '<div class="score">' + (team.score || 0) + '</div></div>';
                });
                document.getElementById('final-leaderboard').innerHTML = html || '<p style="text-align: center; color: #666;">Sin resultados</p>';
            });
        }

        // HELPERS
        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            return code;
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
    </script>
</body>
</html>




